<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Autocorrelation functions of individual charge dipole moments in DL_MESO_DPD &#8212; E-CAM Software Library 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/ecam_logo.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="First version of DL_MESO_DPD code for NVidia GPU" href="../../DL_MESO_DPD_onGPU/add_gpu_version/readme.html" />
    <link rel="prev" title="Test case: a dimer solvent" href="../dipole_af_dlmeso_dpd/dimers.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../DL_MESO_DPD_onGPU/add_gpu_version/readme.html" title="First version of DL_MESO_DPD code for NVidia GPU"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../dipole_af_dlmeso_dpd/dimers.html" title="Test case: a dimer solvent"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">E-CAM Software Library 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Meso- and Multi-scale Modules</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="autocorrelation-functions-of-individual-charge-dipole-moments-in-dl-meso-dpd">
<span id="moldip-af"></span><h1>Autocorrelation functions of individual charge dipole moments in DL_MESO_DPD<a class="headerlink" href="#autocorrelation-functions-of-individual-charge-dipole-moments-in-dl-meso-dpd" title="Permalink to this headline">¶</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Software Technical Information</p>
<dl class="last docutils">
<dt>Language</dt>
<dd>FORTRAN 90</dd>
<dt>Licence</dt>
<dd>BSD</dd>
<dt>Documentation Tool</dt>
<dd>RST and LaTex-generated .pdf file</dd>
<dt>Application Documentation</dt>
<dd><a class="reference download internal" href="../../../../_downloads/manaf1.pdf" download=""><code class="xref download docutils literal"><span class="pre">Click</span> <span class="pre">to</span> <span class="pre">download</span> <span class="pre">the</span> <span class="pre">manual</span></code></a> with more details</dd>
<dt>Relevant Training Material</dt>
<dd>See the Testing section</dd>
</dl>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#purpose-of-module" id="id6">Purpose of Module</a></li>
<li><a class="reference internal" href="#background-information" id="id7">Background Information</a></li>
<li><a class="reference internal" href="#testing" id="id8">Testing</a></li>
<li><a class="reference internal" href="#source-code" id="id9">Source Code</a></li>
</ul>
</div>
<div class="section" id="purpose-of-module">
<h2><a class="toc-backref" href="#id6">Purpose of Module</a><a class="headerlink" href="#purpose-of-module" title="Permalink to this headline">¶</a></h2>
<p>This module, <code class="docutils literal"><span class="pre">gen_moldipaf.f90</span></code>, is a post-processing utility for
DL_MESO_DPD, the Dissipative Particle Dynamics (DPD) code from the <a class="reference external" href="http://www.ccp5.ac.uk/DL_MESO">DL_MESO</a> package.</p>
<p>It processes the trajectory (HISTORY) files to obtain the charge dipole moments
of all the (neutral) molecules in the system, and subsequently computes
the dipole autocorrelation functions (DAFs) for individual molecules, for each molecule type.
It produces a file <cite>MDIPAFDAT</cite> containing both the un-normalized and
normalized DAFs, and, optionally, a file <cite>MDIPAFFFT</cite> containing the
Fourier transform (FT) of the latter.
It is analogous to <code class="docutils literal"><span class="pre">gen_dipoleaf.f90</span></code>, but deals with individual (for a
single molecule) rather then macroscopic (for the simulated volume) charge dipole moments.</p>
<p>The module can be applied to systems including molecules with a generic charge structure, as long
as each molecule is neutral (otherwise the charge dipole moment would be
frame-dependent) <a class="footnote-reference" href="#id4" id="id1">[1]</a>. <strong>CAVEAT</strong>: this module only analyzes molecular trajectories. If a charged molecule
is present, an error message will be given, while unbonded charges would not be
detected and would lead to erroneous results. Therefore please keep in mind
<strong>to not apply</strong> the module to systems with unbonded charges.</p>
<p>The charge dipole moment of a neutral molecule is <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\vec{p}_{mol}=\sum_{i\in mol}q_i \vec{r}_i</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 where
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\vec{r}_i</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 are the bead positions and <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">q_i</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 their charges. The
total charge dipole moment of the simulated volume <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">V</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 is
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\vec{P}=\sum_{mol\in V} \vec{p}_{mol}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
.
If more than one molecular species are present, one can split <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\vec{P}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>

into the different species contributions:
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\vec{P}=\sum_{j = 1}^{N_{moldef}} \vec{P}^{(j)}=\sum_{j = 1}^{N_{moldef}} \sum_{k = 1}^{N_{mol}^{(j)}} \vec{p}_k^{\,(j)}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
,
where <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">N_{moldef}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 is the number of molecule types (definitions) and
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">N_{mol}^{(j)}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 the number of molecules of type <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">j</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
.</p>
<p>Given a scalar quantity <cite>A</cite>, its non-normalized autocorrelation function (AF) is
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">C_{AA}(t) = \langle A(0)A(t)\rangle</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
, where <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\langle\dots\rangle</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>

indicates an average over trajectories. The normalized one is
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">c_{AA}(t) = \frac {\langle A(0)A(t)\rangle}{\langle A(0)A(0)\rangle} = \frac{C_{AA}(t)}{C_{AA}(0)}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 <a class="footnote-reference" href="#id5" id="id2">[2]</a>.</p>
<p>Here for the <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">j</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 -th molecular species we replace <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">A</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 with
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\vec{p}^{(j)}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
, and the product with a scalar product.
In this case the average over trajectories translates into two sums, one
over different time origins and one over molecules of species <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">j</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
.</p>
<p>The output file <cite>MDIPAFDAT</cite> contains the DAFs for each molecular species and,
at the end of the file, the DAF obtained averaging over <em>all</em> the particles.
The output file <cite>MDIPAFFFT</cite> contains the FT of these functions, in the same order.</p>
<p>More in detail, the header of the file <cite>MDIPAFDAT</cite> contains the simulation title and a line with the
number of snapshots in HISTORY and of those used for the AFs (<cite>naf</cite>). Then a block follows for each
molecule type, started by the <em>{molecule name}</em>, then three columns of data,
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">t, C_{\vec{p}\vec{p}},c_{\vec{p}\vec{p}}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
.
It is intended that in any block only the molecules for
a given species are summed over. The last block is called <em>{all species}</em>
and refers to an average over all the molecules.</p>
<p>The header of the file <cite>MDIPAFFFT</cite> is as for <cite>MDIPAFDAT</cite> (notice that
the number of points for the FT is also set equal to <cite>naf</cite>). Then a block follows for each
molecule type, started by the molecule name, then three columns of data,
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\omega, \Re e[\hat{c}_{\vec{p}\vec{p}}(\omega)], \Im m[\hat{c}_{\vec{p}\vec{p}}(\omega)]</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
,
where <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\hat{c}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 is the discrete FT of <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">c(t)</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
.</p>
<p>Possible uses of the output file are: to analyze it to obtain the decay time of
autocorrelations, which can be used to define an efficient sampling of the
simulation; to compare it with the analogous macroscopic one obtained
for all the molecules (of a given type) in the system (see <a class="reference internal" href="../dipole_af_dlmeso_dpd/readme.html#dipole-af"><span class="std std-ref">Autocorrelation functions of charge dipole moments in DL_MESO_DPD</span></a>).</p>
</div>
<div class="section" id="background-information">
<h2><a class="toc-backref" href="#id7">Background Information</a><a class="headerlink" href="#background-information" title="Permalink to this headline">¶</a></h2>
<p>The base code for this module is DL_MESO_DPD, the Dissipative Particle
Dynamics code from the mesoscopic simulation package <a class="reference external" href="http://www.ccp5.ac.uk/DL_MESO">DL_MESO</a>,
developed by M. Seaton at Daresbury Laboratory.
This open source code is available from STFC under both academic (free) and
commercial (paid) licenses. The module is to be used with DL_MESO
in its last released version, version 2.6 (dating November 2015).</p>
<p>Also, the present module requires the library <a class="reference external" href="http://www.fftw.org/">FFTW</a> (version 3.x) to be installed.</p>
</div>
<div class="section" id="testing">
<h2><a class="toc-backref" href="#id8">Testing</a><a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>The present module <code class="docutils literal"><span class="pre">gen_moldipaf.f90</span></code> is compiled with the available Fortran90 compiler, e.g.:</p>
<p><code class="docutils literal"><span class="pre">gfortran</span> <span class="pre">-lfftw3</span> <span class="pre">-lm</span> <span class="pre">-o</span> <span class="pre">gen_moldipaf.exe</span> <span class="pre">gen_moldipaf.f90</span></code></p>
<p>and the executable must be in the same directory of the HISTORY* files to be
analyzed.  In case the file <cite>fftw3.f</cite>, containing constants that are necessary
for the Fourier transform, is not found by the compiler, a simple way out is
to copy it in the same directory where the module is run.
The user is asked to provide the number of nodes used to run the
simulation, the electric charges for all the types of beads
and the maximum number of snapshots to be used for the AFs (<cite>naf</cite>).
Finally, the last input is a switch for the Fourier transform: 1 for <em>yes</em>, 0 (or any other integer) for <em>no</em>.</p>
<p>To input these parameters one can enter them from the keyboard or
write them into a text file (say, <cite>input.txt</cite>), one per line (in the right order) and run the program in this way:</p>
<p><code class="docutils literal"><span class="pre">gen_dipoleaf.exe</span> <span class="pre">&lt;</span> <span class="pre">input.txt</span></code></p>
<p><strong>Test: water in oil</strong></p>
<p>As a test, we suggest to consider a fluid made of harmonically bonded dimers
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">(+q,-q)</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
. Fixing appropriately the partial charge <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">q</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>

and the Bjerrum length <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">l_B</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>
 this system
mimics water in an oil background, as long as the dielectric properties
are concerned. For more details about this model, please see the page <a class="reference internal" href="../dipole_af_dlmeso_dpd/dimers.html#dimers"><span class="std std-ref">Test case: a dimer solvent</span></a>.</p>
<p>Run DL_MESO_DPD using for the CONTROL file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DL_MESO</span> <span class="n">charged</span> <span class="n">harmonic</span> <span class="n">dimers</span> <span class="k">with</span> <span class="n">dpd</span> <span class="n">repulsion</span>

<span class="n">volume</span> <span class="mf">64.0</span>
<span class="n">temperature</span> <span class="mf">1.0</span>
<span class="n">cutoff</span> <span class="mf">1.0</span>

<span class="n">timestep</span> <span class="mf">0.01</span>
<span class="n">steps</span> <span class="mi">70000</span>
<span class="n">equilibration</span> <span class="n">steps</span> <span class="mi">20000</span>
<span class="n">traj</span> <span class="mi">20000</span> <span class="mi">10</span>
<span class="n">stats</span> <span class="n">every</span> <span class="mi">100</span>
<span class="n">stack</span> <span class="n">size</span> <span class="mi">100</span>
<span class="nb">print</span> <span class="n">every</span> <span class="mi">100</span>
<span class="n">job</span> <span class="n">time</span> <span class="mf">7200.0</span>
<span class="n">close</span> <span class="n">time</span> <span class="mf">10.0</span>

<span class="n">ensemble</span> <span class="n">nvt</span> <span class="n">mdvv</span>

<span class="n">ewald</span> <span class="nb">sum</span> <span class="mf">1.0</span> <span class="mi">5</span> <span class="mi">5</span> <span class="mi">5</span>
<span class="n">bjerrum</span> <span class="mf">42.0</span>
<span class="n">smear</span> <span class="n">gauss</span> <span class="n">equal</span>

<span class="n">finish</span>
</pre></div>
</div>
<p>and for the FIELD file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DL_MESO</span> <span class="n">charged</span> <span class="n">harmonic</span> <span class="n">dimers</span> <span class="k">with</span> <span class="n">dpd</span> <span class="n">repulsion</span>

<span class="n">SPECIES</span> <span class="mi">2</span>
<span class="n">solp</span>  <span class="mf">1.0</span>   <span class="mf">0.46</span>  <span class="mi">0</span>
<span class="n">solm</span>  <span class="mf">1.0</span>  <span class="o">-</span><span class="mf">0.46</span>  <span class="mi">0</span>

<span class="n">MOLECULES</span> <span class="mi">1</span>
<span class="n">DIMER</span>
<span class="n">nummols</span> <span class="mi">96</span>
<span class="n">beads</span> <span class="mi">2</span>
<span class="n">solp</span>  <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">solm</span>  <span class="mf">0.1</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">bonds</span> <span class="mi">1</span>
<span class="n">harm</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mf">5.0</span> <span class="mf">0.0</span>

<span class="n">finish</span>

<span class="n">INTERACTIONS</span> <span class="mi">3</span>
<span class="n">solp</span>  <span class="n">solp</span>  <span class="n">dpd</span> <span class="mf">25.0</span> <span class="mf">1.0</span> <span class="mf">4.5</span>
<span class="n">solm</span>  <span class="n">solm</span>  <span class="n">dpd</span> <span class="mf">25.0</span> <span class="mf">1.0</span> <span class="mf">4.5</span>
<span class="n">solp</span>  <span class="n">solm</span>  <span class="n">dpd</span> <span class="mf">25.0</span> <span class="mf">1.0</span> <span class="mf">4.5</span>

<span class="n">CLOSE</span>
</pre></div>
</div>
<p>Analyzing the HISTORY file with <cite>gen_moldipaf.exe</cite> choosing <em>naf=100</em>, i.e.,
using this input.txt (which assumes a serial run)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">1</span>
<span class="mf">0.46</span>
<span class="o">-</span><span class="mf">0.46</span>
<span class="mi">100</span>
<span class="mi">1</span>
</pre></div>
</div>
<p>this output is printed on
the standard output</p>
<div class="highlight-default"><div class="highlight"><pre><span></span> Number of nodes used in calculations ?
 nchist:            0          96           0           0           0           0           0           0           0           0
 Charges for SPECIES type solp     :
 Charges for SPECIES type solm     :
chg=       0.4600      -0.4600
 Number of time steps in autocorrelation profile? 
 switch for FFT computation? (1=yes, 0 or any other integer=no)
</pre></div>
</div>
<p>The first line shows the histogram of cluster sizes: in this case,
it correctly gives 96 molecules of two beads.
Since internally the module checks that each molecule is a connected cluster <a class="footnote-reference" href="#id4" id="id3">[1]</a>,
this line should always give a histogram with the molecule sizes
(by default, shown up to ten beads).</p>
<p>The <cite>MDIPAFDAT</cite> file is (only the first fifteen lines are shown)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DL_MESO</span> <span class="n">charged</span> <span class="n">harmonic</span> <span class="n">dimers</span> <span class="k">with</span> <span class="n">dpd</span> <span class="n">repulsion</span>                              
      <span class="mi">5001</span>       <span class="mi">100</span>


<span class="n">DIMER</span>   
  <span class="mf">0.000000E+00</span>  <span class="mf">1.419184E-01</span>  <span class="mf">1.000000E+00</span>
  <span class="mf">1.000000E-01</span>  <span class="mf">1.360256E-01</span>  <span class="mf">9.584780E-01</span>
  <span class="mf">2.000000E-01</span>  <span class="mf">1.217816E-01</span>  <span class="mf">8.581103E-01</span>
  <span class="mf">3.000000E-01</span>  <span class="mf">1.045570E-01</span>  <span class="mf">7.367406E-01</span>
  <span class="mf">4.000000E-01</span>  <span class="mf">8.750295E-02</span>  <span class="mf">6.165724E-01</span>
  <span class="mf">5.000000E-01</span>  <span class="mf">7.161709E-02</span>  <span class="mf">5.046358E-01</span>
  <span class="mf">6.000000E-01</span>  <span class="mf">5.723649E-02</span>  <span class="mf">4.033057E-01</span>
  <span class="mf">7.000000E-01</span>  <span class="mf">4.466587E-02</span>  <span class="mf">3.147293E-01</span>
  <span class="mf">8.000000E-01</span>  <span class="mf">3.406310E-02</span>  <span class="mf">2.400189E-01</span>
  <span class="mf">9.000000E-01</span>  <span class="mf">2.537519E-02</span>  <span class="mf">1.788013E-01</span>
</pre></div>
</div>
<p>and the <cite>MDIPAFFFT</cite> file is (only the first fifteen lines are shown)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DL_MESO</span> <span class="n">charged</span> <span class="n">harmonic</span> <span class="n">dimers</span> <span class="k">with</span> <span class="n">dpd</span> <span class="n">repulsion</span>                              
      <span class="mi">5001</span>       <span class="mi">100</span>


<span class="n">DIMER</span>   
  <span class="mf">0.000000E+00</span>  <span class="mf">6.013063E+00</span>  <span class="mf">0.000000E+00</span>
  <span class="mf">6.283185E-01</span>  <span class="mf">5.915405E+00</span> <span class="o">-</span><span class="mf">1.378369E+00</span>
  <span class="mf">1.256637E+00</span>  <span class="mf">5.283007E+00</span> <span class="o">-</span><span class="mf">2.365590E+00</span>
  <span class="mf">1.884956E+00</span>  <span class="mf">4.077657E+00</span> <span class="o">-</span><span class="mf">3.150028E+00</span>
  <span class="mf">2.513274E+00</span>  <span class="mf">3.076368E+00</span> <span class="o">-</span><span class="mf">3.326590E+00</span>
  <span class="mf">3.141593E+00</span>  <span class="mf">2.244706E+00</span> <span class="o">-</span><span class="mf">3.195932E+00</span>
  <span class="mf">3.769911E+00</span>  <span class="mf">1.631808E+00</span> <span class="o">-</span><span class="mf">2.873471E+00</span>
  <span class="mf">4.398230E+00</span>  <span class="mf">1.273571E+00</span> <span class="o">-</span><span class="mf">2.521504E+00</span>
  <span class="mf">5.026548E+00</span>  <span class="mf">1.024723E+00</span> <span class="o">-</span><span class="mf">2.219809E+00</span>
  <span class="mf">5.654867E+00</span>  <span class="mf">8.805952E-01</span> <span class="o">-</span><span class="mf">1.950491E+00</span>
</pre></div>
</div>
<p>Below we show a plot of the normalized AF <div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\frac {\langle \vec{p}(0)\vec{p}(t)\rangle}{\langle\vec{p}(0)\vec{p}(0)\rangle}</tt>)</p>
latex exited with error
[stderr]

kpathsea: Running mktexfmt latex.fmt
mktexfmt: mktexfmt is using the following fmtutil.cnf files (in precedence order):
mktexfmt:   /usr/share/texmf/web2c/fmtutil.cnf
mktexfmt:   /usr/share/texlive/texmf-dist/web2c/fmtutil.cnf
mktexfmt: mktexfmt is using the following fmtutil.cnf file for writing changes:
mktexfmt:   /home/ffrancesco/.texlive2017/texmf-config/web2c/fmtutil.cnf
mktexfmt [INFO]: writing formats under /home/ffrancesco/.texlive2017/texmf-var/web2c
mktexfmt [INFO]: did not find entry for byfmt=latex, skipped
mktexfmt [INFO]: Not selected formats: 27
mktexfmt [INFO]: Total formats: 27
mktexfmt [INFO]: exiting with status 0

[stdout]
This is pdfTeX, Version 3.14159265-2.6-1.40.18 (TeX Live 2017/Debian) (preloaded format=latex)
 restricted \write18 enabled.
I can&#8217;t find the format file `latex.fmt&#8217;!
</div>

(obtained using the first and third columns of <cite>MDIPAFDAT</cite>)</p>
<a class="reference internal image-reference" href="../../../../_images/maf-dimers.jpg"><img alt="../../../../_images/maf-dimers.jpg" class="align-center" src="../../../../_images/maf-dimers.jpg" style="width: 30%;" /></a>
</div>
<div class="section" id="source-code">
<h2><a class="toc-backref" href="#id9">Source Code</a><a class="headerlink" href="#source-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-fortran"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744
745
746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781
782
783
784
785
786
787
788
789
790
791
792
793
794
795
796
797
798
799
800
801
802
803
804
805
806
807
808
809
810
811
812
813
814
815
816
817
818
819
820
821
822
823
824
825
826
827
828
829
830
831
832
833
834
835
836
837
838
839
840
841
842
843
844
845
846
847
848
849
850
851
852
853
854
855
856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885
886
887
888
889
890
891
892</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">PROGRAM </span><span class="n">gen_moldipaf</span>
<span class="c">!*************************************************************************************</span>
<span class="c">! module to compute autocorrelation functions of individual charge dipole moments in</span>
<span class="c">! DL_MESO_DPD</span>
<span class="c">!</span>
<span class="c">! authors: m. a. seaton and s. chiacchiera, March 2017 (amended August 2017)</span>
<span class="c">!*************************************************************************************         </span>
      <span class="k">IMPLICIT none</span>
<span class="k">      </span><span class="kt">INTEGER</span><span class="p">,</span> <span class="k">PARAMETER</span> <span class="kd">::</span> <span class="n">dp</span> <span class="o">=</span> <span class="nb">SELECTED_REAL_KIND</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">307</span><span class="p">)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">PARAMETER</span> <span class="kd">::</span> <span class="n">ntraj</span><span class="o">=</span><span class="mi">10</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">PARAMETER</span> <span class="kd">::</span> <span class="n">pi</span><span class="o">=</span><span class="mf">3.141592653589793_dp</span>
      
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="kd">::</span> <span class="n">text</span><span class="p">,</span> <span class="n">a2</span>
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">namspe</span> <span class="p">(:),</span> <span class="n">nammol</span> <span class="p">(:)</span>
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chan</span>
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a1</span>
      
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">ltp</span> <span class="p">(:),</span> <span class="n">ltm</span> <span class="p">(:),</span> <span class="n">mole</span> <span class="p">(:),</span> <span class="n">bndtbl</span> <span class="p">(:,:),</span> <span class="n">beads</span> <span class="p">(:),</span> <span class="n">bonds</span> <span class="p">(:)</span> 
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">nbdmol</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">visit</span> <span class="p">(:),</span> <span class="n">from</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nrtout</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">chain</span><span class="p">,</span> <span class="n">imol</span><span class="p">,</span> <span class="n">ioerror</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">numtraj</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">nmoldef</span><span class="p">,</span> <span class="n">ibond</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nspe</span><span class="p">,</span> <span class="n">numnodes</span><span class="p">,</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nusyst</span><span class="p">,</span> <span class="n">nmbeads</span><span class="p">,</span> <span class="n">nsyst</span><span class="p">,</span> <span class="n">nbonds</span><span class="p">,</span> <span class="n">numbond</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nummol</span><span class="p">,</span> <span class="n">lfrzn</span><span class="p">,</span> <span class="n">rnmol</span><span class="p">,</span> <span class="n">keytrj</span><span class="p">,</span> <span class="n">srfx</span><span class="p">,</span> <span class="n">srfy</span><span class="p">,</span> <span class="n">srfz</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">naf</span><span class="p">,</span> <span class="n">nsamp</span>
      
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">xxx</span> <span class="p">(:),</span> <span class="n">yyy</span> <span class="p">(:),</span> <span class="n">zzz</span> <span class="p">(:)</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">nmol</span> <span class="p">(:),</span> <span class="n">chg</span> <span class="p">(:),</span> <span class="n">molchg</span> <span class="p">(:)</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">dipx_box</span> <span class="p">(:),</span> <span class="n">dipy_box</span> <span class="p">(:),</span> <span class="n">dipz_box</span> <span class="p">(:)</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">dipx</span> <span class="p">(:),</span> <span class="n">dipy</span> <span class="p">(:),</span> <span class="n">dipz</span> <span class="p">(:)</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">mdipdata</span> <span class="p">(:,:,:),</span> <span class="n">corrdata</span> <span class="p">(:)</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volm</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">shrdx</span><span class="p">,</span> <span class="n">shrdy</span><span class="p">,</span> <span class="n">shrdz</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">amass</span><span class="p">,</span> <span class="n">rcii</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="nb">time</span><span class="p">,</span> <span class="n">mbeads</span><span class="p">,</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fz</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r4</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dt</span><span class="p">,</span> <span class="n">time0</span><span class="p">,</span> <span class="n">domega</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dx0</span><span class="p">,</span> <span class="n">dy0</span><span class="p">,</span> <span class="n">dz0</span> 

      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nftpts</span>
      <span class="kt">COMPLEX</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">fftdata</span> <span class="p">(:)</span>
      
      <span class="kt">LOGICAL</span> <span class="kd">::</span> <span class="n">eof</span><span class="p">,</span> <span class="n">lfft</span>
      
      <span class="c">! Get number of nodes </span>

      <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Number of nodes used in calculations ?&quot;</span>
      <span class="k">READ</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">numnodes</span>
      
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">beads</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">),</span> <span class="n">bonds</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">))</span>
      
      <span class="c">! Determine if HISTORY files exist</span>

      <span class="k">IF</span> <span class="p">(</span><span class="n">numnodes</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         INQUIRE</span> <span class="p">(</span><span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY000000&#39;</span><span class="p">,</span> <span class="n">EXIST</span> <span class="o">=</span> <span class="n">eof</span><span class="p">)</span>
      <span class="k">ELSE</span>
<span class="k">         INQUIRE</span> <span class="p">(</span><span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="p">,</span> <span class="n">EXIST</span> <span class="o">=</span> <span class="n">eof</span><span class="p">)</span>
      <span class="k">END IF</span>
<span class="k">      IF</span> <span class="p">(.</span><span class="nb">NOT</span><span class="p">.</span> <span class="n">eof</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: cannot find HISTORY files&quot;</span>
         <span class="k">STOP</span>
<span class="k">      END IF</span>

      <span class="c">! First reading, where the number of beads, molecules and bonds are determined</span>
      <span class="c">! Arrays are filled with names of particles and molecules</span>
      <span class="c">! If multiple HISTORY files are present, it is checked they are compatible</span>
      
      <span class="n">numbond</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;(i6.6)&#39;</span><span class="p">)</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">numnodes</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="o">//</span><span class="n">chan</span><span class="p">,</span> <span class="nb">access</span> <span class="o">=</span> <span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
         <span class="k">ELSE</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="p">,</span> <span class="nb">access</span> <span class="o">=</span> <span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
         <span class="k">END IF</span>
<span class="k">         </span>
<span class="k">         IF</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">nspe</span><span class="p">,</span> <span class="n">nmoldef</span><span class="p">,</span> <span class="n">nusyst</span><span class="p">,</span> <span class="n">nsyst</span><span class="p">,</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nbonds</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">volm</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">keytrj</span><span class="p">,</span> <span class="n">srfx</span><span class="p">,</span> <span class="n">srfy</span><span class="p">,</span> <span class="n">srfz</span>
         <span class="k">ELSE</span>
<span class="k">            READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nbonds</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r4</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">n1</span> <span class="o">/=</span> <span class="n">nspe</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n2</span> <span class="o">/=</span> <span class="n">nmoldef</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n3</span> <span class="o">/=</span> <span class="n">nusyst</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n4</span> <span class="o">/=</span> <span class="n">nsyst</span> <span class="p">&amp;</span>
                <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">r1</span> <span class="o">/=</span> <span class="n">dimx</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">r2</span> <span class="o">/=</span> <span class="n">dimy</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">r3</span> <span class="o">/=</span> <span class="n">dimz</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">r4</span> <span class="o">/=</span> <span class="n">volm</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>
               <span class="k">STOP</span>
<span class="k">            </span><span class="n">ENDIF</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">n1</span> <span class="o">/=</span> <span class="n">keytrj</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n2</span> <span class="o">/=</span> <span class="n">srfx</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n3</span> <span class="o">/=</span> <span class="n">srfy</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n4</span> <span class="o">/=</span> <span class="n">srfz</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>
               <span class="k">STOP</span>
<span class="k">            </span><span class="n">ENDIF</span>
         <span class="n">ENDIF</span>

         <span class="n">beads</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbeads</span>
         <span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbonds</span>
         <span class="n">numbond</span> <span class="o">=</span> <span class="n">numbond</span> <span class="o">+</span> <span class="n">nbonds</span>
      <span class="k">END DO</span> <span class="c">! loop over nodes</span>

      <span class="k">IF</span> <span class="p">(</span><span class="n">numbond</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         PRINT</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;ERROR: no molecules in trajectory data!&#39;</span>
         <span class="k">STOP</span>
<span class="k">      END IF</span>

<span class="k">      IF</span> <span class="p">(</span><span class="n">srfx</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">srfy</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">srfz</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: Hard walls, electrostatics not implemented in DL_MESO_DPD yet!&quot;</span>
         <span class="k">STOP</span>
<span class="k">      END IF</span>
<span class="k">      </span>
<span class="k">      IF</span> <span class="p">(</span><span class="n">srfx</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">srfy</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">srfz</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: System under shear, not implemented yet!&quot;</span>
         <span class="k">STOP</span>
<span class="k">      END IF</span>
            
<span class="c">!     get number of beads to be tracked when reading trajectory file (molecular beads)</span>
      <span class="n">nmbeads</span> <span class="o">=</span> <span class="n">nsyst</span> <span class="o">-</span> <span class="n">nusyst</span>

      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">namspe</span> <span class="p">(</span><span class="n">nspe</span><span class="p">),</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">nmoldef</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">xxx</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmbeads</span><span class="p">),</span> <span class="n">yyy</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmbeads</span><span class="p">),</span> <span class="n">zzz</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmbeads</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">ltp</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmbeads</span><span class="p">),</span> <span class="n">ltm</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmbeads</span><span class="p">),</span> <span class="n">mole</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmbeads</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">nmol</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmoldef</span><span class="p">),</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmoldef</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">chg</span> <span class="p">(</span><span class="n">nspe</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">bndtbl</span> <span class="p">(</span><span class="n">numbond</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">visit</span> <span class="p">(</span><span class="n">nmbeads</span><span class="p">),</span> <span class="n">from</span> <span class="p">(</span><span class="n">nmbeads</span><span class="p">))</span> 

      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspe</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">namspe</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">amass</span><span class="p">,</span> <span class="n">rcii</span><span class="p">,</span> <span class="n">lfrzn</span>
            <span class="k">ELSE</span>
<span class="k">               READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">a1</span><span class="p">,</span> <span class="n">amass</span><span class="p">,</span> <span class="n">rcii</span><span class="p">,</span> <span class="n">lfrzn</span>
               <span class="k">IF</span> <span class="p">(</span><span class="n">a1</span> <span class="o">/=</span> <span class="n">namspe</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="k">THEN</span>
<span class="k">                  WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>
                  <span class="k">STOP</span>
<span class="k">               </span><span class="n">ENDIF</span>
            <span class="n">ENDIF</span>
         <span class="k">END DO</span>

<span class="k">         IF</span> <span class="p">(</span><span class="n">nmoldef</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
               <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                  READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
               <span class="k">ELSE</span>
<span class="k">                  READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">a1</span>
                  <span class="k">IF</span> <span class="p">(</span><span class="n">a1</span> <span class="o">/=</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="k">THEN</span>
<span class="k">                     WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>
                     <span class="k">STOP</span>
<span class="k">                  </span><span class="n">ENDIF</span>
               <span class="k">END IF</span>
<span class="k">            END DO</span>
<span class="k">         END IF</span>

<span class="k">         IF</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">text</span>
         <span class="k">ELSE</span>
<span class="k">            READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">a2</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">a2</span> <span class="o">/=</span> <span class="n">text</span><span class="p">)</span> <span class="k">THEN </span>
<span class="k">               WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>            
               <span class="k">STOP</span>
<span class="k">            </span><span class="n">ENDIF</span>
         <span class="n">ENDIF</span>
            
      <span class="n">ENDDO</span> <span class="c">! end of loop over nodes</span>

      <span class="c">! reading of ONLY one HISTORY file till the end to get numtraj</span>
      <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">beads</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
         <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">)</span> <span class="c">!global, species, molecule, chain</span>
      <span class="n">ENDDO</span>
      <span class="k">IF</span> <span class="p">(</span><span class="n">bonds</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bonds</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">)</span> <span class="c">!bead1, bead2</span>
         <span class="k">END DO</span>
<span class="k">      END IF</span>

<span class="k">      </span><span class="n">numtraj</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="n">time0</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      
      <span class="k">DO WHILE</span> <span class="p">(.</span><span class="n">true</span><span class="p">.)</span>
         
         <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">,</span> <span class="n">IOSTAT</span><span class="o">=</span><span class="n">ioerror</span><span class="p">)</span> <span class="nb">time</span><span class="p">,</span> <span class="n">mbeads</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">shrdx</span><span class="p">,</span> <span class="n">shrdy</span><span class="p">,</span> <span class="n">shrdz</span>

         <span class="k">IF</span> <span class="p">(</span><span class="n">ioerror</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            EXIT</span>
<span class="k">         ELSE</span>
<span class="k">            </span><span class="n">numtraj</span> <span class="o">=</span> <span class="n">numtraj</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">numtraj</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="n">time0</span> <span class="o">=</span> <span class="nb">time</span>
<span class="nb">            </span><span class="n">nbeads</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">mbeads</span><span class="p">)</span>
            <span class="k">SELECT CASE</span> <span class="p">(</span><span class="n">keytrj</span><span class="p">)</span>
            <span class="k">CASE</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
               <span class="k">END DO</span>
<span class="k">            CASE</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span>
               <span class="k">END DO</span>
<span class="k">            CASE</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fz</span>
               <span class="k">END DO</span>
<span class="k">            END SELECT</span>
<span class="k">         END IF</span>
<span class="k">         </span>
<span class="k">      END DO</span>
<span class="k">      </span>
<span class="k">      DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">CLOSE</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">END DO</span>

<span class="k">      </span><span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="nb">time</span> <span class="o">-</span> <span class="n">time0</span><span class="p">)</span> <span class="o">/</span> <span class="kt">REAL</span> <span class="p">(</span><span class="n">numtraj</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span>

      <span class="c">! Second reading, where arrays are filled with properties of beads and molecules.</span>
      <span class="c">! Then, the snapshots of trajectories are read.</span>

      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;(i6.6)&#39;</span><span class="p">)</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">numnodes</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="o">//</span><span class="n">chan</span><span class="p">,</span> <span class="nb">access</span> <span class="o">=</span> <span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
         <span class="k">ELSE</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="p">,</span> <span class="nb">access</span> <span class="o">=</span> <span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
         <span class="k">END IF     </span>
<span class="k">      </span>
<span class="k">         READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!nspe, nmoldef, nusyst, nsyst, nbeads, nbonds</span>
         <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!dimx, dimy, dimz, volm</span>
         <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!keytrj, srfx, srfy, srfz</span>

         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspe</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!namspe (i), amass, rcii, lfrzn</span>
         <span class="k">END DO</span>
<span class="k">         </span>
<span class="k">         DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!nammol (i)</span>
         <span class="k">END DO</span>
<span class="k">         </span>
<span class="k">         READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!text</span>
      <span class="k">END DO</span>

<span class="k">      </span><span class="n">nummol</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">!counter for number of molecules      </span>
      <span class="n">ibond</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c">!counter for bonds</span>
      
      <span class="c">!     fill in arrays for beads and bonds</span>
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="c">!Build ltp, ltm, mole</span>
         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">beads</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">chain</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">global</span><span class="o">&gt;</span><span class="n">nusyst</span> <span class="p">.</span><span class="nb">AND</span><span class="p">.</span> <span class="n">global</span><span class="o">&lt;=</span><span class="n">nsyst</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               </span><span class="n">ltp</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">species</span>
               <span class="n">ltm</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">molecule</span>
               <span class="n">mole</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">chain</span>
               <span class="n">nummol</span> <span class="o">=</span> <span class="nb">MAX</span> <span class="p">(</span><span class="n">nummol</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>
            <span class="n">ENDIF</span>
         <span class="k">END DO</span>
<span class="k">         </span>
<span class="k">         IF</span> <span class="p">(</span><span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
            <span class="c">! Build bndtbl</span>
            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
               <span class="n">ibond</span> <span class="o">=</span> <span class="n">ibond</span> <span class="o">+</span> <span class="mi">1</span>
               <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
               <span class="n">bndtbl</span> <span class="p">(</span><span class="n">ibond</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">bead1</span>
               <span class="n">bndtbl</span> <span class="p">(</span><span class="n">ibond</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">bead2</span>
            <span class="k">END DO</span>
<span class="k">         END IF   </span>
<span class="k">      END DO</span> <span class="c">! over nodes</span>
      
      <span class="k">IF</span> <span class="p">(</span><span class="n">ibond</span> <span class="o">/=</span> <span class="n">numbond</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: bndtbl is not completely full!&quot;</span>
         <span class="k">STOP</span>
<span class="k">      </span><span class="n">ENDIF</span>
         
      <span class="n">bndtbl</span> <span class="o">=</span> <span class="n">bndtbl</span> <span class="o">-</span> <span class="n">nusyst</span>

      <span class="c">! obtain connectivity information (needed only once)</span>
      <span class="k">CALL </span><span class="n">connect</span> <span class="p">(</span><span class="n">nmbeads</span><span class="p">,</span> <span class="n">numbond</span><span class="p">,</span> <span class="n">bndtbl</span><span class="p">,</span> <span class="n">visit</span><span class="p">,</span> <span class="n">from</span><span class="p">)</span> 
      
      <span class="c">! determine numbers of molecules and beads per molecule type</span>
      <span class="n">nmol</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="n">nbdmol</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">chain</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">imol</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">!necessary to avoid out of bounds</span>
         
      <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmbeads</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">mole</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/=</span> <span class="n">chain</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">chain</span> <span class="o">=</span> <span class="n">mole</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">imol</span> <span class="o">=</span> <span class="n">ltm</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">nmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">nmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0_dp</span>
         <span class="k">END IF</span>
<span class="k">         IF</span> <span class="p">(</span><span class="n">imol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">END DO</span>
<span class="k">                  </span>
<span class="k">      DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
         <span class="n">rnmol</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">nmol</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">rnmol</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">nbdmol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">rnmol</span>
         <span class="k">END IF</span>
<span class="k">      END DO</span>

      <span class="c">!Asking the user to input the charges for each particle species</span>
      <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspe</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Charges for SPECIES type &quot;</span><span class="p">,</span> <span class="n">namspe</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="s2">&quot; :&quot;</span>
         <span class="k">READ</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">chg</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
      <span class="k">END DO</span>

<span class="k">      WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(&quot;chg=&quot;,10(3x,f10.4))&#39;</span><span class="p">)</span> <span class="n">chg</span>
      
      <span class="c">!Checking for charge neutrality of all molecules</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">molchg</span> <span class="p">(</span><span class="n">nummol</span><span class="p">))</span>

      <span class="n">molchg</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mf">0._dp</span>

      <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmbeads</span>
         <span class="n">imol</span> <span class="o">=</span> <span class="n">mole</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
         <span class="n">molchg</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">molchg</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">+</span> <span class="n">chg</span> <span class="p">(</span><span class="n">ltp</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
      <span class="k">END DO</span>

<span class="k">      DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nummol</span>
         <span class="k">IF</span> <span class="p">(</span><span class="nb">ABS</span> <span class="p">(</span><span class="n">molchg</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1.d-16</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;molecule number&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot; is not neutral! (The dipole moment is frame-dependent)&quot;</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;its charge is=&quot;</span><span class="p">,</span> <span class="n">molchg</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;its type is=&quot;</span><span class="p">,</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">STOP</span>
<span class="k">         </span><span class="n">ENDIF</span>
      <span class="k">END DO</span>

<span class="k">      call </span><span class="n">check_molecules</span> <span class="c">!checks that beads are labelled as expected</span>
      
      <span class="c">! Get the maximum number of time steps for autocorrelation                                                                                        </span>
      <span class="c">! and adjust it if necessary</span>
      <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Number of time steps in autocorrelation profile? &quot;</span>
      <span class="k">READ</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">naf</span>
      <span class="k">IF</span> <span class="p">(</span><span class="n">naf</span><span class="o">&lt;</span><span class="mi">1</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">naf</span><span class="o">&gt;</span> <span class="n">numtraj</span><span class="p">)</span> <span class="n">naf</span> <span class="o">=</span> <span class="n">numtraj</span>

      <span class="c">! Get the switch for FFT computation</span>
      <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;switch for FFT computation? (1=yes, 0 or any other integer=no)&quot;</span>
      <span class="k">READ</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">n1</span>
      <span class="n">lfft</span> <span class="o">=</span> <span class="p">(</span><span class="n">n1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
      
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">mdipdata</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">nummol</span><span class="p">,</span> <span class="n">numtraj</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">dipx</span> <span class="p">(</span><span class="n">nummol</span><span class="p">),</span> <span class="n">dipy</span> <span class="p">(</span><span class="n">nummol</span><span class="p">),</span> <span class="n">dipz</span> <span class="p">(</span><span class="n">nummol</span><span class="p">))</span>
      
      <span class="c">!reading trajectories and computing charge dipole moments</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">dipx_box</span> <span class="p">(</span><span class="n">nmoldef</span><span class="p">),</span> <span class="n">dipy_box</span> <span class="p">(</span><span class="n">nmoldef</span><span class="p">),</span> <span class="n">dipz_box</span> <span class="p">(</span><span class="n">nmoldef</span><span class="p">))</span>

      <span class="n">eof</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="k">DO WHILE</span> <span class="p">(.</span><span class="n">true</span><span class="p">.)</span>
         <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">,</span> <span class="n">IOSTAT</span><span class="o">=</span><span class="n">ioerror</span><span class="p">)</span> <span class="nb">time</span><span class="p">,</span> <span class="n">mbeads</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">shrdx</span><span class="p">,</span> <span class="n">shrdy</span><span class="p">,</span> <span class="n">shrdz</span> 
         
         <span class="k">IF</span> <span class="p">(</span><span class="n">ioerror</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">eof</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ERROR: cannot find trajectory data in HISTORY files&#39;</span>
               <span class="k">STOP</span>
<span class="k">            END IF</span>
<span class="k">            EXIT</span>
<span class="k">         END IF</span>
<span class="k">         </span>
<span class="k">         </span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
         
         <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>

            <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">IOSTAT</span><span class="o">=</span><span class="n">ioerror</span><span class="p">)</span> <span class="nb">time</span><span class="p">,</span> <span class="n">mbeads</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">shrdx</span><span class="p">,</span> <span class="n">shrdy</span><span class="p">,</span> <span class="n">shrdz</span>              
               <span class="k">IF</span> <span class="p">(</span><span class="n">ioerror</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                  </span><span class="n">eof</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ERROR: End of file reached prematurely - &#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39; timesteps written&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
                       <span class="s1">&#39; to output files&#39;</span> 
                  <span class="k">EXIT</span>
<span class="k">               END IF</span>
<span class="k">            END IF</span>
<span class="k">            </span>
<span class="k">            </span><span class="n">nbeads</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">mbeads</span><span class="p">)</span>
         
            <span class="k">SELECT CASE</span> <span class="p">(</span><span class="n">keytrj</span><span class="p">)</span>
            <span class="k">CASE</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
                  <span class="n">global</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">mglobal</span><span class="p">)</span>
                  <span class="k">IF</span> <span class="p">(</span><span class="n">global</span><span class="o">&gt;</span><span class="n">nusyst</span> <span class="p">.</span><span class="nb">AND</span><span class="p">.</span> <span class="n">global</span><span class="o">&lt;=</span><span class="n">nsyst</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                     </span><span class="n">xxx</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
                     <span class="n">yyy</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span>
                     <span class="n">zzz</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">z</span>
                  <span class="k">END IF</span>
<span class="k">               END DO</span>
<span class="k">            CASE</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span>
                  <span class="n">global</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">mglobal</span><span class="p">)</span>
                  <span class="k">IF</span> <span class="p">(</span><span class="n">global</span><span class="o">&gt;</span><span class="n">nusyst</span> <span class="p">.</span><span class="nb">AND</span><span class="p">.</span> <span class="n">global</span><span class="o">&lt;=</span><span class="n">nsyst</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                     </span><span class="n">xxx</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
                     <span class="n">yyy</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span>
                     <span class="n">zzz</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">z</span>
                  <span class="k">END IF</span>
<span class="k">               END DO</span>
<span class="k">            CASE</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fz</span>
                  <span class="n">global</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">mglobal</span><span class="p">)</span>
                  <span class="k">IF</span> <span class="p">(</span><span class="n">global</span><span class="o">&gt;</span><span class="n">nusyst</span> <span class="p">.</span><span class="nb">AND</span><span class="p">.</span> <span class="n">global</span><span class="o">&lt;=</span><span class="n">nsyst</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                     </span><span class="n">xxx</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
                     <span class="n">yyy</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span>
                     <span class="n">zzz</span> <span class="p">(</span><span class="n">global</span><span class="o">-</span><span class="n">nusyst</span><span class="p">)</span> <span class="o">=</span> <span class="n">z</span>
                  <span class="k">END IF</span>
<span class="k">               END DO</span>
<span class="k">            END SELECT</span>

<span class="k">         END DO</span> <span class="c">! over nodes</span>
            
         <span class="k">call </span><span class="n">compute_charge_dipoles</span> <span class="p">(</span><span class="n">dipx_box</span><span class="p">,</span> <span class="n">dipy_box</span><span class="p">,</span> <span class="n">dipz_box</span><span class="p">,</span> <span class="n">dipx</span><span class="p">,</span> <span class="n">dipy</span><span class="p">,</span> <span class="n">dipz</span><span class="p">)</span>

         <span class="c">! the dipole components for each individual molecule are stored for all the snapshots </span>
         <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nummol</span>
            <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipx</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> 
            <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipy</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> 
            <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipz</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> 
            <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">time</span>
<span class="nb">         </span><span class="k">END DO</span>
<span class="k">         </span>
<span class="k">      END DO</span> <span class="c">! end of loop over trajectories</span>

      <span class="k">IF</span> <span class="p">(</span><span class="n">k</span> <span class="o">/=</span> <span class="n">numtraj</span><span class="p">)</span><span class="k">THEN</span>
<span class="k">         WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: problem with the number of snapshots!&quot;</span> 
         <span class="k">STOP</span>
<span class="k">      END IF</span>
<span class="k">         </span>
<span class="k">      </span><span class="n">nsamp</span> <span class="o">=</span> <span class="n">numtraj</span> <span class="o">-</span> <span class="n">naf</span> <span class="o">+</span> <span class="mi">1</span>
      
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">corrdata</span> <span class="p">(</span><span class="n">naf</span><span class="p">))</span>

      <span class="c">! define FFT size if needed</span>
      <span class="k">IF</span> <span class="p">(</span><span class="n">lfft</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         </span><span class="n">nftpts</span> <span class="o">=</span> <span class="n">naf</span> <span class="c">! modify here to change the size of the DFT</span>
         <span class="n">domega</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="n">dt</span> <span class="o">*</span> <span class="n">nftpts</span><span class="p">)</span>
         <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">fftdata</span> <span class="p">(</span><span class="n">nftpts</span><span class="p">))</span>
      <span class="k">END IF</span>
      
      <span class="c">! Open output file, compute the autocorrelation and write it there</span>
      <span class="n">nrtout</span> <span class="o">=</span> <span class="n">ntraj</span> <span class="o">+</span> <span class="n">numnodes</span> 
      
      <span class="k">IF</span> <span class="p">(</span><span class="n">numtraj</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         </span>
<span class="k">         OPEN</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;MDIPAFDAT&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span> <span class="s1">&#39;(a80)&#39;</span><span class="p">)</span> <span class="n">text</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span> <span class="s1">&#39;(2i10)&#39;</span><span class="p">)</span> <span class="n">k</span><span class="p">,</span><span class="n">naf</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span> <span class="s1">&#39;(/)&#39;</span><span class="p">)</span>

         <span class="c">! Open the FT otuput file if needed</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lfft</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;MDIPAFFFT&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;(a80)&#39;</span><span class="p">)</span> <span class="n">text</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;(2i10)&#39;</span><span class="p">)</span> <span class="n">k</span><span class="p">,</span><span class="n">nftpts</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;(/)&#39;</span><span class="p">)</span>
         <span class="k">END IF       </span>
<span class="k">         </span>
<span class="k">         </span><span class="n">imol</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">! counter for molecules</span>
         <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
            <span class="n">rnmol</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">nmol</span> <span class="p">(</span><span class="n">j</span><span class="p">))</span>
            <span class="n">corrdata</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span><span class="s1">&#39;(a8)&#39;</span><span class="p">)</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lfft</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;(a8)&#39;</span><span class="p">)</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsamp</span>
               <span class="k">DO </span><span class="n">k</span> <span class="o">=</span> <span class="n">imol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imol</span> <span class="o">+</span> <span class="n">rnmol</span>
                  <span class="n">dx0</span> <span class="o">=</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                  <span class="n">dy0</span> <span class="o">=</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                  <span class="n">dz0</span> <span class="o">=</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                  <span class="k">DO </span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">naf</span>
                     <span class="n">corrdata</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">corrdata</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx0</span> <span class="o">+</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dy0</span> <span class="p">&amp;</span>
                          <span class="o">+</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dz0</span>
                  <span class="k">END DO   </span>
<span class="k">               END DO</span>
<span class="k">            END DO</span>
<span class="k">          </span><span class="n">corrdata</span> <span class="o">=</span> <span class="n">corrdata</span> <span class="o">/</span> <span class="p">(</span><span class="kt">REAL</span> <span class="p">(</span><span class="n">nsamp</span><span class="p">,</span> <span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="o">*</span> <span class="n">nmol</span> <span class="p">(</span><span class="n">j</span><span class="p">))</span>
          <span class="n">imol</span> <span class="o">=</span> <span class="n">imol</span> <span class="o">+</span> <span class="n">rnmol</span>

          <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">naf</span>
             <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span> <span class="s1">&#39;(1p,3e14.6)&#39;</span><span class="p">)</span> <span class="kt">REAL</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">corrdata</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">corrdata</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">corrdata</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
          <span class="k">END DO</span>
<span class="k">          WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span> <span class="s1">&#39;(/)&#39;</span><span class="p">)</span>
          <span class="k">IF</span> <span class="p">(</span><span class="n">lfft</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">             </span><span class="n">fftdata</span> <span class="p">(:)</span> <span class="o">=</span> <span class="n">corrdata</span> <span class="p">(:)</span><span class="o">/</span> <span class="n">corrdata</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">! adapt here if nftpts differs from naf</span>
             <span class="k">call </span><span class="n">fft</span> <span class="p">(</span><span class="n">fftdata</span><span class="p">)</span>
             <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nftpts</span>
                <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;(1p,3e14.6)&#39;</span><span class="p">)</span> <span class="kt">REAL</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span><span class="o">*</span><span class="n">domega</span><span class="p">,</span> <span class="n">fftdata</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
             <span class="k">END DO</span>
<span class="k">             WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;(/)&#39;</span><span class="p">)</span>
          <span class="k">END IF</span>
<span class="k">       END DO</span>
<span class="k">       </span><span class="n">corrdata</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
       <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span> <span class="s1">&#39;(&quot;all species&quot;)&#39;</span><span class="p">)</span>
       <span class="k">IF</span> <span class="p">(</span><span class="n">lfft</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;(&quot;all species&quot;)&#39;</span><span class="p">)</span>
       <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsamp</span>
          <span class="k">DO </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nummol</span>
             <span class="n">dx0</span> <span class="o">=</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
             <span class="n">dy0</span> <span class="o">=</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
             <span class="n">dz0</span> <span class="o">=</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
             <span class="k">DO </span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">naf</span>
                <span class="n">corrdata</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">corrdata</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx0</span> <span class="o">+</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dy0</span> <span class="p">&amp;</span>
                     <span class="o">+</span> <span class="n">mdipdata</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dz0</span>
             <span class="k">END DO</span>
<span class="k">          END DO</span>
<span class="k">       END DO</span>
<span class="k">       </span><span class="n">corrdata</span> <span class="o">=</span> <span class="n">corrdata</span> <span class="o">/</span> <span class="p">(</span><span class="kt">REAL</span> <span class="p">(</span><span class="n">nsamp</span><span class="p">,</span> <span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="o">*</span> <span class="n">nummol</span><span class="p">)</span>
       
       <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">naf</span>
          <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span> <span class="s1">&#39;(1p,3e14.6)&#39;</span><span class="p">)</span> <span class="kt">REAL</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">corrdata</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">corrdata</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">corrdata</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
       <span class="k">END DO</span>
<span class="k">       WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">,</span> <span class="s1">&#39;(/)&#39;</span><span class="p">)</span>
       <span class="k">IF</span> <span class="p">(</span><span class="n">lfft</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">          </span><span class="n">fftdata</span> <span class="p">(:)</span> <span class="o">=</span> <span class="n">corrdata</span> <span class="p">(:)</span><span class="o">/</span> <span class="n">corrdata</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">! adapt here if nftpts differs from naf</span>
          <span class="k">call </span><span class="n">fft</span> <span class="p">(</span><span class="n">fftdata</span><span class="p">)</span>
          <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nftpts</span>
             <span class="k">WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;(1p,3e14.6)&#39;</span><span class="p">)</span> <span class="kt">REAL</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span><span class="o">*</span><span class="n">domega</span><span class="p">,</span> <span class="n">fftdata</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
          <span class="k">END DO</span>
<span class="k">          WRITE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;(/)&#39;</span><span class="p">)</span>
       <span class="k">END IF</span>
<span class="k">    END IF</span>
            
      <span class="c">! Close the trajectory files</span>
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">CLOSE</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">END DO</span>

      <span class="c">! Close the output files</span>
      <span class="k">CLOSE</span> <span class="p">(</span><span class="n">nrtout</span><span class="p">)</span>
      <span class="k">IF</span> <span class="p">(</span><span class="n">lfft</span><span class="p">)</span> <span class="k">CLOSE</span> <span class="p">(</span><span class="n">nrtout</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
      
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">beads</span><span class="p">,</span> <span class="n">bonds</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">namspe</span><span class="p">,</span> <span class="n">nammol</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">yyy</span><span class="p">,</span> <span class="n">zzz</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">ltm</span><span class="p">,</span> <span class="n">mole</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">nmol</span><span class="p">,</span> <span class="n">nbdmol</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">chg</span><span class="p">,</span> <span class="n">molchg</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">dipx_box</span><span class="p">,</span> <span class="n">dipy_box</span><span class="p">,</span> <span class="n">dipz_box</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">bndtbl</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">visit</span><span class="p">,</span> <span class="n">from</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">mdipdata</span><span class="p">,</span> <span class="n">corrdata</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">dipx</span><span class="p">,</span> <span class="n">dipy</span><span class="p">,</span> <span class="n">dipz</span><span class="p">)</span>
      <span class="k">IF</span> <span class="p">(</span><span class="n">lfft</span><span class="p">)</span> <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">fftdata</span><span class="p">)</span>
      
    <span class="k">CONTAINS</span>

<span class="k">      SUBROUTINE </span><span class="n">check_molecules</span>
<span class="c">!*************************************************************************************</span>
<span class="c">! subroutine to check molecular content and labelling</span>
<span class="c">!</span>
<span class="c">! authors: s. chiacchiera, February 2017 </span>
<span class="c">!*************************************************************************************         </span>
        <span class="k">IMPLICIT NONE</span>
<span class="k">        </span><span class="kt">INTEGER </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">imol</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">ibd</span>
        <span class="kt">INTEGER </span><span class="n">mxmolsize</span>
        <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">molbeads</span> <span class="p">(:,:)</span>
        
        <span class="n">mxmolsize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
           <span class="n">mxmolsize</span> <span class="o">=</span> <span class="nb">MAX</span> <span class="p">(</span><span class="n">nbdmol</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">mxmolsize</span><span class="p">)</span>
        <span class="k">END DO</span>
<span class="k">        ALLOCATE</span> <span class="p">(</span><span class="n">molbeads</span> <span class="p">(</span><span class="n">nmoldef</span><span class="p">,</span> <span class="n">mxmolsize</span><span class="p">))</span>
        <span class="n">molbeads</span> <span class="p">(:,:)</span> <span class="o">=</span> <span class="mi">0</span> 
        
        <span class="n">imol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ibd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
           <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">nmol</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
              <span class="n">imol</span> <span class="o">=</span> <span class="n">imol</span> <span class="o">+</span><span class="mi">1</span>
              <span class="k">DO </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbdmol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                 <span class="n">ibd</span> <span class="o">=</span> <span class="n">ibd</span> <span class="o">+</span><span class="mi">1</span>
                 <span class="n">tm</span> <span class="o">=</span> <span class="n">ltm</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span>
                 <span class="n">tp</span> <span class="o">=</span> <span class="n">ltp</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span>
                 <span class="n">im</span> <span class="o">=</span> <span class="n">mole</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span>
                 <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                    </span><span class="n">molbeads</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">tp</span>
                 <span class="k">ELSE</span>
<span class="k">                    IF</span> <span class="p">(</span><span class="n">molbeads</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">/=</span> <span class="n">tp</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                       WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: Problem with molecular content!&quot;</span>
                       <span class="k">STOP   </span>
<span class="k">                    </span><span class="n">ENDIF</span>
                 <span class="n">ENDIF</span>
                 <span class="k">IF</span> <span class="p">(</span><span class="n">tm</span><span class="o">/=</span><span class="n">i</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">im</span><span class="o">/=</span><span class="n">imol</span><span class="p">)</span><span class="k">THEN</span>
<span class="k">                    WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: Problem with molecules labels!&quot;</span>
                    <span class="k">STOP</span>
<span class="k">                 </span><span class="n">ENDIF</span>
              <span class="k">END DO</span>
<span class="k">           END DO</span>
<span class="k">        END DO</span>
<span class="k">        IF</span> <span class="p">(</span><span class="n">imol</span><span class="o">/=</span><span class="n">nummol</span><span class="p">)</span> <span class="k">THEN </span>
<span class="k">           WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: imol and nummol differ!&quot;</span>
           <span class="k">STOP</span>
<span class="k">        </span><span class="n">ENDIF</span>
        <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">molbeads</span><span class="p">)</span>
        <span class="k">RETURN</span>
<span class="k">      END SUBROUTINE </span><span class="n">check_molecules</span>

      <span class="k">SUBROUTINE </span><span class="n">compute_charge_dipoles</span> <span class="p">(</span><span class="n">dipx_box</span><span class="p">,</span> <span class="n">dipy_box</span><span class="p">,</span> <span class="n">dipz_box</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span><span class="p">)</span>
<span class="c">!*************************************************************************************</span>
<span class="c">! subroutine to compute charge dipole moments</span>
<span class="c">!</span>
<span class="c">! authors: m. a. seaton and s. chiacchiera, February 2017 </span>
<span class="c">!</span>
<span class="c">! input: xxx, yyy, zzz (at a given time step) and chg </span>
<span class="c">! input: visit and from (obtained using connect) </span>
<span class="c">! output: the x,y,z components of the total dipole, for each molecule type and all</span>
<span class="c">!         individual dipoles (at a given time step) </span>
<span class="c">!</span>
<span class="c">! (NB: this is a slightly modified version, with different output)</span>
<span class="c">!*************************************************************************************   </span>
        <span class="k">IMPLICIT NONE</span>
<span class="k">        </span><span class="kt">INTEGER </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">tm</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">imol</span><span class="p">,</span> <span class="n">ibd</span><span class="p">,</span> <span class="nb">count</span><span class="p">,</span> <span class="n">ipr</span> 
        <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">nmoldef</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dipx_box</span><span class="p">,</span> <span class="n">dipy_box</span><span class="p">,</span> <span class="n">dipz_box</span>
        <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">xpre</span><span class="p">,</span> <span class="n">ypre</span><span class="p">,</span> <span class="n">zpre</span>
        <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dipx</span><span class="p">,</span> <span class="n">dipy</span><span class="p">,</span> <span class="n">dipz</span>
        <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">nmbeads</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xabs</span><span class="p">,</span> <span class="n">yabs</span><span class="p">,</span> <span class="nb">zabs</span>
<span class="nb">        </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">DIMENSION</span><span class="p">(</span><span class="n">nummol</span><span class="p">)</span> <span class="kd">::</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">pz</span> 
        
        <span class="n">dipx_box</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mf">0._dp</span>
        <span class="n">dipy_box</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mf">0._dp</span>
        <span class="n">dipz_box</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mf">0._dp</span>

        <span class="n">imol</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">count</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="c">! xabs = 0._dp ! just to keep it clean</span>
        <span class="c">! yabs = 0._dp</span>
        <span class="c">! zabs = 0._dp</span>
        
        <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
           <span class="n">tm</span> <span class="o">=</span> <span class="n">i</span> 
           <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">nmol</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
              <span class="n">imol</span> <span class="o">=</span> <span class="n">imol</span> <span class="o">+</span> <span class="mi">1</span>

              <span class="n">dipx</span> <span class="o">=</span> <span class="mf">0._dp</span> <span class="c">! dipole of a SINGLE molecule</span>
              <span class="n">dipy</span> <span class="o">=</span> <span class="mf">0._dp</span>
              <span class="n">dipz</span> <span class="o">=</span> <span class="mf">0._dp</span>

              <span class="k">DO </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbdmol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                 <span class="nb">count</span> <span class="o">=</span> <span class="nb">count</span> <span class="o">+</span> <span class="mi">1</span>
                 <span class="n">ibd</span> <span class="o">=</span> <span class="n">visit</span> <span class="p">(</span><span class="nb">count</span><span class="p">)</span>
                 <span class="n">ipr</span> <span class="o">=</span> <span class="n">from</span> <span class="p">(</span><span class="nb">count</span><span class="p">)</span>
                 
                 <span class="k">IF</span> <span class="p">(</span><span class="n">ipr</span> <span class="o">/=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                    </span><span class="n">xpre</span> <span class="o">=</span> <span class="n">xabs</span> <span class="p">(</span><span class="n">ipr</span><span class="p">)</span>
                    <span class="n">ypre</span> <span class="o">=</span> <span class="n">yabs</span> <span class="p">(</span><span class="n">ipr</span><span class="p">)</span>
                    <span class="n">zpre</span> <span class="o">=</span> <span class="nb">zabs</span> <span class="p">(</span><span class="n">ipr</span><span class="p">)</span>
                 <span class="k">ELSE</span>
<span class="k">                    IF</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                       </span><span class="n">xpre</span> <span class="o">=</span> <span class="mf">0._dp</span>
                       <span class="n">ypre</span> <span class="o">=</span> <span class="mf">0._dp</span>
                       <span class="n">zpre</span> <span class="o">=</span> <span class="mf">0._dp</span>
                    <span class="k">ELSE</span>
<span class="k">                       WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Unconnected molecule!&quot;</span>
                       <span class="k">STOP</span>
<span class="k">                    </span><span class="n">ENDIF</span>
                 <span class="n">ENDIF</span>

                 <span class="n">tp</span> <span class="o">=</span> <span class="n">ltp</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span>
                 
                 <span class="n">dx</span> <span class="o">=</span> <span class="n">xxx</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span> <span class="o">-</span> <span class="n">xpre</span>  
                 <span class="n">dy</span> <span class="o">=</span> <span class="n">yyy</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span> <span class="o">-</span> <span class="n">ypre</span>  
                 <span class="n">dz</span> <span class="o">=</span> <span class="n">zzz</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span> <span class="o">-</span> <span class="n">zpre</span>
                 
                 <span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">-</span> <span class="n">dimx</span> <span class="o">*</span> <span class="nb">ANINT</span> <span class="p">(</span><span class="n">dx</span><span class="o">/</span><span class="n">dimx</span><span class="p">)</span>
                 <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">-</span> <span class="n">dimy</span> <span class="o">*</span> <span class="nb">ANINT</span> <span class="p">(</span><span class="n">dy</span><span class="o">/</span><span class="n">dimy</span><span class="p">)</span>
                 <span class="n">dz</span> <span class="o">=</span> <span class="n">dz</span> <span class="o">-</span> <span class="n">dimz</span> <span class="o">*</span> <span class="nb">ANINT</span> <span class="p">(</span><span class="n">dz</span><span class="o">/</span><span class="n">dimz</span><span class="p">)</span>
                 
                 <span class="n">x</span> <span class="o">=</span> <span class="n">xpre</span> <span class="o">+</span> <span class="n">dx</span>
                 <span class="n">y</span> <span class="o">=</span> <span class="n">ypre</span> <span class="o">+</span> <span class="n">dy</span>
                 <span class="n">z</span> <span class="o">=</span> <span class="n">zpre</span> <span class="o">+</span> <span class="n">dz</span>
                 
                 
                 <span class="n">dipx</span> <span class="o">=</span> <span class="n">dipx</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">chg</span> <span class="p">(</span><span class="n">tp</span><span class="p">)</span>
                 <span class="n">dipy</span> <span class="o">=</span> <span class="n">dipy</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">chg</span> <span class="p">(</span><span class="n">tp</span><span class="p">)</span>
                 <span class="n">dipz</span> <span class="o">=</span> <span class="n">dipz</span> <span class="o">+</span> <span class="n">z</span> <span class="o">*</span> <span class="n">chg</span> <span class="p">(</span><span class="n">tp</span><span class="p">)</span>
                 
                 <span class="n">xabs</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
                 <span class="n">yabs</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span>
                 <span class="nb">zabs</span> <span class="p">(</span><span class="n">ibd</span><span class="p">)</span> <span class="o">=</span> <span class="n">z</span>
                 
               <span class="k">END DO</span>

               <span class="c">! storing dipole moments of individual molecules </span>
               <span class="n">px</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipx</span>
               <span class="n">py</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipy</span>               
               <span class="n">pz</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipz</span>
               
              <span class="n">dipx_box</span> <span class="p">(</span><span class="n">tm</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipx_box</span> <span class="p">(</span><span class="n">tm</span><span class="p">)</span> <span class="o">+</span> <span class="n">dipx</span>
              <span class="n">dipy_box</span> <span class="p">(</span><span class="n">tm</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipy_box</span> <span class="p">(</span><span class="n">tm</span><span class="p">)</span> <span class="o">+</span> <span class="n">dipy</span>
              <span class="n">dipz_box</span> <span class="p">(</span><span class="n">tm</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipz_box</span> <span class="p">(</span><span class="n">tm</span><span class="p">)</span> <span class="o">+</span> <span class="n">dipz</span>
              
           <span class="k">END DO</span>
<span class="k">        END DO</span>

<span class="k">        IF</span> <span class="p">(</span><span class="n">imol</span><span class="o">/=</span><span class="n">nummol</span><span class="p">)</span> <span class="k">THEN </span>
<span class="k">           WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: imol and nummol differ!&quot;</span>
           <span class="k">STOP</span>
<span class="k">        </span><span class="n">ENDIF</span>
        
        <span class="k">RETURN</span>
<span class="k">      END SUBROUTINE </span><span class="n">compute_charge_dipoles</span>

<span class="k">SUBROUTINE </span><span class="n">fft</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c">!*************************************************************************************         </span>
<span class="c">! Subroutine to call FFTW (v3) one-dimensional complex DFT.</span>
<span class="c">! Notice that the input array is overwritten with the its Discrete Fourier Transform.</span>
<span class="c">!</span>
<span class="c">! author: s. chiacchiera, August 2017 </span>
<span class="c">!*************************************************************************************         </span>
  <span class="k">IMPLICIT NONE</span>
<span class="k">  INCLUDE</span> <span class="s2">&quot;fftw3.f&quot;</span>
  <span class="kt">COMPLEX</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span> <span class="p">(:)</span>
  <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">n</span>
  <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span> <span class="kd">::</span> <span class="n">plan</span>

      <span class="n">n</span> <span class="o">=</span> <span class="n">SIZE</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>

      <span class="k">call </span><span class="n">dfftw_plan_dft_1d</span> <span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">FFTW_FORWARD</span><span class="p">,</span> <span class="n">FFTW_ESTIMATE</span><span class="p">)</span>
      <span class="k">call </span><span class="n">dfftw_execute_dft</span> <span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
      <span class="k">call </span><span class="n">dfftw_destroy_plan</span> <span class="p">(</span><span class="n">plan</span><span class="p">)</span>
      
      <span class="k">RETURN</span>
<span class="k">      </span>
<span class="k">END SUBROUTINE </span><span class="n">fft</span>
      
<span class="k">End PROGRAM </span><span class="n">gen_moldipaf</span>

<span class="k">SUBROUTINE </span><span class="n">connect</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">,</span> <span class="n">nbonds</span><span class="p">,</span> <span class="n">bndtbl</span><span class="p">,</span> <span class="n">visit</span><span class="p">,</span> <span class="n">from</span><span class="p">)</span>
<span class="c">!**********************************************************************</span>
<span class="c">!  Analyzes all the bonds (bndtbl) to obtain a schedule (visit, from) </span>
<span class="c">!  to visit the beads so that each cluster is visited along a connected</span>
<span class="c">!  path. &quot;visit&quot; gives the order to include beads, &quot;from&quot; gives the bead </span>
<span class="c">!  to attach them to.</span>
<span class="c">!  (Note: vocabulary from infection propagation used to move along</span>
<span class="c">!  clusters)</span>
<span class="c">!</span>
<span class="c">!  author: s. chiacchiera, February 2017 </span>
<span class="c">!**********************************************************************</span>
  <span class="k">IMPLICIT none</span>
<span class="k">      </span><span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span> <span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nbonds</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span> <span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">bndtbl</span> <span class="p">(</span><span class="n">nbonds</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">ic</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">nclu</span><span class="p">,</span> <span class="n">nper</span><span class="p">,</span> <span class="n">lab</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="nb">count</span> <span class="c">!j</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">mxmolsize</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">firstnn</span> <span class="p">(:),</span> <span class="n">lastnn</span> <span class="p">(:),</span> <span class="n">deg</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">labnn</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">state</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">perlab</span> <span class="p">(:),</span> <span class="n">perref</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">nchist</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span> <span class="p">(</span><span class="n">OUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">visit</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">),</span> <span class="n">from</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">)</span>
      
      <span class="n">mxmolsize</span> <span class="o">=</span> <span class="mi">10</span>

      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">firstnn</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">),</span> <span class="n">lastnn</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">),</span> <span class="n">deg</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">),</span> <span class="n">labnn</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nbonds</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">state</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">perlab</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">),</span> <span class="n">perref</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">))</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">nchist</span> <span class="p">(</span><span class="n">mxmolsize</span><span class="p">))</span> 
      <span class="c">!-----------------------------------------------------------------------</span>
      <span class="k">CALL </span><span class="n">organize</span> <span class="p">(</span><span class="n">nbeads</span><span class="p">,</span> <span class="n">nbonds</span><span class="p">,</span> <span class="n">labnn</span><span class="p">,</span> <span class="n">firstnn</span><span class="p">,</span> <span class="n">lastnn</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>
      <span class="c">!-----------------------------------------------------------------------</span>
      <span class="n">state</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">nchist</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">visit</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">from</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nb">count</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="c">!-----------------------------------------------------------------------</span>
      <span class="n">ic</span> <span class="o">=</span> <span class="mi">0</span> 
      <span class="c">!-----------------------------------------------------------------------</span>
      <span class="k">DO WHILE</span> <span class="p">(</span><span class="n">ic</span> <span class="o">&lt;</span> <span class="n">nbeads</span><span class="p">)</span> <span class="c">! ic = label of bead used to &quot;grow&quot; a cluster</span>
         <span class="n">ic</span> <span class="o">=</span> <span class="n">ic</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="k">IF</span><span class="p">(</span> <span class="n">state</span> <span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">/=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: labels are not as expected!&quot;</span>
            <span class="k">STOP</span>
<span class="k">         END IF</span>
<span class="k">         </span><span class="n">nclu</span> <span class="o">=</span> <span class="mi">1</span> 
         <span class="nb">count</span> <span class="o">=</span> <span class="nb">count</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="n">visit</span> <span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="n">ic</span> 
         <span class="k">IF</span> <span class="p">(</span><span class="n">deg</span> <span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">state</span> <span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">nclu</span> <span class="o">&lt;=</span> <span class="n">mxmolsize</span><span class="p">)</span> <span class="n">nchist</span> <span class="p">(</span><span class="n">nclu</span><span class="p">)</span> <span class="o">=</span> <span class="n">nchist</span> <span class="p">(</span><span class="n">nclu</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span>
            <span class="k">CYCLE</span>
<span class="k">         END IF</span>
<span class="k">         </span><span class="n">state</span> <span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>          <span class="c">! ic is &quot;infected&quot;</span>

         <span class="c">! nearest neighbours of ic are marked as &quot;goint to be infected&quot; -&gt; a.k.a. perimeter  </span>
         <span class="n">nper</span> <span class="o">=</span> <span class="mi">0</span> 
         <span class="n">perlab</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">perref</span> <span class="p">(:)</span> <span class="o">=</span> <span class="mi">0</span>         
         <span class="k">DO </span><span class="n">k</span> <span class="o">=</span> <span class="n">firstnn</span> <span class="p">(</span><span class="n">ic</span><span class="p">),</span> <span class="n">lastnn</span> <span class="p">(</span><span class="n">ic</span><span class="p">)</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">labnn</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">IF</span><span class="p">(</span> <span class="n">state</span> <span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">/=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: labels are not as expected!&quot;</span>
               <span class="k">STOP</span>
<span class="k">            END IF</span>
<span class="k">            </span><span class="n">nper</span> <span class="o">=</span> <span class="n">nper</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">perlab</span> <span class="p">(</span><span class="n">nper</span><span class="p">)</span> <span class="o">=</span> <span class="n">nn</span> <span class="c">!new bead in perimeter</span>
            <span class="n">perref</span> <span class="p">(</span><span class="n">nper</span><span class="p">)</span> <span class="o">=</span> <span class="n">ic</span>  <span class="c">!its reference bead (origin of the link)</span>
            <span class="n">state</span> <span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span>
         <span class="k">END DO</span>
<span class="k">         </span><span class="n">state</span> <span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span> <span class="c">! ic is &quot;dead&quot;</span>
         
         <span class="k">DO WHILE</span> <span class="p">(</span><span class="n">nper</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! pick a bead of &quot;perimeter&quot; to be analyzed</span>
            <span class="n">lab</span> <span class="o">=</span> <span class="n">perlab</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">perref</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>            
            <span class="n">perlab</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">perlab</span> <span class="p">(</span><span class="n">nper</span><span class="p">)</span>            
            <span class="n">perref</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">perref</span> <span class="p">(</span><span class="n">nper</span><span class="p">)</span>                        
            <span class="n">nper</span> <span class="o">=</span> <span class="n">nper</span> <span class="o">-</span> <span class="mi">1</span> 
            <span class="k">IF</span> <span class="p">(</span><span class="n">state</span> <span class="p">(</span><span class="n">lab</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               CYCLE</span>
<span class="k">            END IF</span>
<span class="k">            </span><span class="n">state</span> <span class="p">(</span><span class="n">lab</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! &quot;lab&quot; is added to the cluster</span>
            <span class="n">nclu</span> <span class="o">=</span> <span class="n">nclu</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="nb">count</span> <span class="o">=</span> <span class="nb">count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">visit</span> <span class="p">(</span><span class="nb">count</span><span class="p">)</span> <span class="o">=</span> <span class="n">lab</span>
            <span class="n">from</span> <span class="p">(</span><span class="nb">count</span><span class="p">)</span> <span class="o">=</span> <span class="n">ref</span>
            
            <span class="k">DO </span><span class="n">k</span> <span class="o">=</span> <span class="n">firstnn</span> <span class="p">(</span><span class="n">lab</span><span class="p">),</span> <span class="n">lastnn</span> <span class="p">(</span><span class="n">lab</span><span class="p">)</span>  <span class="c">! check nn of newly added </span>
               <span class="n">nn</span> <span class="o">=</span> <span class="n">labnn</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span>
               <span class="k">IF</span><span class="p">(</span> <span class="p">(</span><span class="n">state</span> <span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="p">(</span><span class="n">state</span> <span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span> <span class="k">CYCLE</span>
<span class="k">               </span><span class="n">nper</span> <span class="o">=</span> <span class="n">nper</span> <span class="o">+</span> <span class="mi">1</span>
               <span class="n">perlab</span> <span class="p">(</span><span class="n">nper</span><span class="p">)</span> <span class="o">=</span> <span class="n">nn</span> <span class="c">!new bead in perimeter</span>
               <span class="n">perref</span> <span class="p">(</span><span class="n">nper</span><span class="p">)</span> <span class="o">=</span> <span class="n">lab</span>  <span class="c">!its reference bead (origin of the link)</span>
               <span class="n">state</span> <span class="p">(</span><span class="n">nn</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">END DO</span>
<span class="k">            </span><span class="n">state</span> <span class="p">(</span><span class="n">lab</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span>            
           
         <span class="k">END DO</span>
<span class="k">         </span><span class="n">nchist</span> <span class="p">(</span><span class="n">nclu</span><span class="p">)</span> <span class="o">=</span> <span class="n">nchist</span> <span class="p">(</span><span class="n">nclu</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span>
         <span class="n">ic</span> <span class="o">=</span> <span class="n">ic</span> <span class="o">+</span> <span class="n">nclu</span> <span class="o">-</span> <span class="mi">1</span> <span class="c">! prepare ic for the next cluster</span>
      <span class="k">END DO</span>
<span class="k">      WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;nchist: &quot;</span><span class="p">,</span> <span class="n">nchist</span>
      <span class="c">!-----------------------------------------------------------------------      </span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">firstnn</span><span class="p">,</span> <span class="n">lastnn</span><span class="p">,</span> <span class="n">deg</span><span class="p">,</span> <span class="n">labnn</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">perlab</span><span class="p">,</span> <span class="n">perref</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">nchist</span><span class="p">)</span> 
      <span class="k">RETURN</span>
      <span class="c">!-----------------------------------------------------------------------</span>
      <span class="k">CONTAINS</span>
      <span class="c">!-----------------------------------------------------------------------</span>
        <span class="k">SUBROUTINE </span><span class="n">organize</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">NL</span><span class="p">,</span> <span class="n">labnn</span><span class="p">,</span> <span class="n">firstnn</span><span class="p">,</span> <span class="n">lastnn</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>
        <span class="c">!**********************************************************************</span>
        <span class="c">! Analyzes the bonds (bndtbl) to obtain the degree (=number of bonds)</span>
        <span class="c">! of each bead, and the nearest neighbours list.</span>
        <span class="c">! N in the number of beads (vertices) and NL of bonds (links). </span>
        <span class="c">!</span>
        <span class="c">! author: s. chiacchiera, February 2017 </span>
        <span class="c">!**********************************************************************</span>
          <span class="k">IMPLICIT none</span>
<span class="k">      </span><span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">N</span><span class="p">,</span> <span class="n">NL</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">count_lab</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span><span class="n">i2</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">DIMENSION</span> <span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">deg</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">DIMENSION</span> <span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">firstnn</span><span class="p">,</span> <span class="n">lastnn</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">DIMENSION</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">NL</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">labnn</span>
      
      <span class="n">deg</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span>
      <span class="n">firstnn</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span>
      <span class="n">lastnn</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span>
      <span class="n">labnn</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span> 

      <span class="n">count_lab</span><span class="o">=</span><span class="mi">0</span>

      <span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
         <span class="k">DO </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NL</span>
            <span class="k">IF</span><span class="p">(</span><span class="n">bndtbl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="n">EQ</span><span class="p">.</span><span class="n">i</span><span class="p">)</span><span class="k">THEN  </span>
<span class="k">               </span><span class="n">deg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">deg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
               <span class="n">count_lab</span><span class="o">=</span><span class="n">count_lab</span><span class="o">+</span><span class="mi">1</span>
               <span class="n">labnn</span><span class="p">(</span><span class="n">count_lab</span><span class="p">)</span><span class="o">=</span><span class="n">bndtbl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ENDIF</span>
            <span class="k">IF</span><span class="p">(</span><span class="n">bndtbl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">2</span><span class="p">).</span><span class="n">EQ</span><span class="p">.</span><span class="n">i</span><span class="p">)</span><span class="k">THEN </span>
<span class="k">               </span><span class="n">deg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">deg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
               <span class="n">count_lab</span><span class="o">=</span><span class="n">count_lab</span><span class="o">+</span><span class="mi">1</span>
               <span class="n">labnn</span><span class="p">(</span><span class="n">count_lab</span><span class="p">)</span><span class="o">=</span><span class="n">bndtbl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ENDIF</span>
         <span class="k">END DO</span>
<span class="k">      END DO</span>
<span class="k">      </span>
<span class="k">      </span><span class="n">i1</span><span class="o">=</span><span class="mi">1</span>
      <span class="n">i2</span><span class="o">=</span><span class="mi">0</span>
      <span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">deg</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">CYCLE</span>
<span class="k">         </span><span class="n">firstnn</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">i1</span>
         <span class="n">i2</span><span class="o">=</span><span class="n">i1</span><span class="o">+</span><span class="n">deg</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
         <span class="n">lastnn</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">i2</span>
         <span class="n">i1</span><span class="o">=</span><span class="n">i2</span><span class="o">+</span><span class="mi">1</span>
      <span class="k">END DO</span>
<span class="k">      </span>
<span class="k">      RETURN</span>
<span class="k">      </span>
<span class="k">    END SUBROUTINE </span><span class="n">organize</span>
    <span class="c">!-----------------------------------------------------------------------</span>
  <span class="k">END SUBROUTINE </span><span class="n">connect</span>
  
</pre></div>
</td></tr></table></div>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id3">2</a>)</em> Disambiguation on the concept of molecule. In DL_MESO a <em>defined molecule</em>
is a set of beads, which can be bonded or not.
For the purpose of this module it is <em>required</em> that each molecule is a
connected cluster (via stretching bonds).
In fact, this, together with the reasonable assumption that each stretching
bond cannot be stretched to more than half the system linear size, allows
to univocally define the charge dipole moment of each molecule.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><ol class="first last upperalpha simple" start="13">
<li><ol class="first upperalpha" start="16">
<li>Allen and D. J. Tildesley, &#8220;Computer simulation of liquids&#8221;, Oxford University Press, Oxford (1987).</li>
</ol>
</li>
</ol>
</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/ecam_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Autocorrelation functions of individual charge dipole moments in DL_MESO_DPD</a><ul>
<li><a class="reference internal" href="#purpose-of-module">Purpose of Module</a></li>
<li><a class="reference internal" href="#background-information">Background Information</a></li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#source-code">Source Code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../dipole_af_dlmeso_dpd/dimers.html"
                        title="previous chapter">Test case: a dimer solvent</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../DL_MESO_DPD_onGPU/add_gpu_version/readme.html"
                        title="next chapter">First version of DL_MESO_DPD code for NVidia GPU</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/Meso-Multi-Scale-Modelling-Modules/modules/DL_MESO_DPD/moldip_af_dlmeso_dpd/readme.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../DL_MESO_DPD_onGPU/add_gpu_version/readme.html" title="First version of DL_MESO_DPD code for NVidia GPU"
             >next</a> |</li>
        <li class="right" >
          <a href="../dipole_af_dlmeso_dpd/dimers.html" title="Test case: a dimer solvent"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">E-CAM Software Library 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Meso- and Multi-scale Modules</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, E-CAM Centre of Excellence.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.
    </div>
  </body>
</html>