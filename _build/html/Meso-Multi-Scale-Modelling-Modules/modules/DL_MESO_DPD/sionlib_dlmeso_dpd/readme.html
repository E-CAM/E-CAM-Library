<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using SIONlib (parallel I/O library) to write/read HISTORY files in DL_MESO_DPD &#8212; E-CAM Software Library 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/ecam_logo.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Scientific Software Best Practices" href="../../../../best-practices/index.html" />
    <link rel="prev" title="Coarse-Graining: A Component of the Hierarchical Equilibration Strategy for Polymer Melts" href="../../hierarchical-strategy/simple_one-component_melts/coarse-graining/readme.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../best-practices/index.html" title="Scientific Software Best Practices"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../../hierarchical-strategy/simple_one-component_melts/coarse-graining/readme.html" title="Coarse-Graining: A Component of the Hierarchical Equilibration Strategy for Polymer Melts"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">E-CAM Software Library 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Meso- and Multi-scale Modules</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="using-sionlib-parallel-i-o-library-to-write-read-history-files-in-dl-meso-dpd">
<span id="dlmeso-sionlib"></span><h1>Using SIONlib (parallel I/O library) to write/read HISTORY files in DL_MESO_DPD<a class="headerlink" href="#using-sionlib-parallel-i-o-library-to-write-read-history-files-in-dl-meso-dpd" title="Permalink to this headline">¶</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Software Technical Information</p>
<dl class="last docutils">
<dt>Language</dt>
<dd>FORTRAN 90</dd>
<dt>Licence</dt>
<dd>BSD / <a class="reference external" href="http://www.ccp5.ac.uk/DL_MESO">DL_MESO</a> Licence for the base code</dd>
<dt>Documentation Tool</dt>
<dd>RST</dd>
<dt>Application Documentation</dt>
<dd>See the Source Code section</dd>
<dt>Relevant Training Material</dt>
<dd>See the Testing section</dd>
</dl>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#purpose-of-module" id="id5">Purpose of Module</a></li>
<li><a class="reference internal" href="#background-information" id="id6">Background Information</a></li>
<li><a class="reference internal" href="#testing" id="id7">Testing</a></li>
<li><a class="reference internal" href="#source-code" id="id8">Source Code</a></li>
</ul>
</div>
<div class="section" id="purpose-of-module">
<h2><a class="toc-backref" href="#id5">Purpose of Module</a><a class="headerlink" href="#purpose-of-module" title="Permalink to this headline">¶</a></h2>
<p>This module proposes to use the <a class="reference external" href="http://www.fz-juelich.de/ias/jsc/EN/Expertise/Support/Software/SIONlib/_node.html">SIONlib</a> library to write/read the trajectory (HISTORY)
files in DL_MESO_DPD, the Dissipative Particle Dynamics (DPD) code from the
<a class="reference external" href="http://www.ccp5.ac.uk/DL_MESO">DL_MESO</a> package. In the last release (2.6, dating November 2015),
the MPI version of DL_MESO_DPD generates <em>multiple</em> trajectory files, one for
each MPI task. The use of <a class="reference external" href="http://www.fz-juelich.de/ias/jsc/EN/Expertise/Support/Software/SIONlib/_node.html">SIONlib</a> allows to minimally modify the writing so that just <em>one</em>
physical file (history.sion) is produced.
An analogous modification has to be implemented in the post-processing
utilities that read the HISTORY files. As an example, here the modifications
are implemented for one specific utility, <code class="docutils literal"><span class="pre">format_history_sion.f90</span></code>, a
formatting tool analogous to <code class="docutils literal"><span class="pre">format_history.f90</span></code> (see <a class="reference internal" href="../format_dlmeso_dpd/readme.html#history-format-dpd"><span class="std std-ref">Formatting the HISTORY files of DL_MESO_DPD</span></a>).
Beside showing how to adapt the reading, this allows a robust check
of the implementation, since the output is human readable, contains the full
trajectories, and can be readily compared with that obtained using <code class="docutils literal"><span class="pre">format_history.f90</span></code>
with the standard version of DL_MESO_DPD.</p>
<p>Notice that the next released version of DL_MESO_DPD (in development)
will tackle the writing of files differently, producing a single trajectory
file from the start. However, the interface proposed here provides this feature
to the users of version 2.6, and represents an alternative solution for the
handling of the trajectories.</p>
<p>The implementation presented here is meant to show the feasibility of the
interfacing, not to deal with all the possible cases.
We therefore restrict in this module to the relevant case in which: i) the simulation is run in
parallel using MPI, ii) a single SIONlib-type physical file is produced, and iii) the
post-processing is done by a single process.</p>
<p>Finally, we would like to underline that, while <a class="reference external" href="http://www.fz-juelich.de/ias/jsc/EN/Expertise/Support/Software/SIONlib/_node.html">SIONlib</a> is optimized for a
large number of MPI tasks, the reduction from
several output files to just one is in any case a benefit, for example when it
comes to the maintenance of the simulation output.</p>
</div>
<div class="section" id="background-information">
<h2><a class="toc-backref" href="#id6">Background Information</a><a class="headerlink" href="#background-information" title="Permalink to this headline">¶</a></h2>
<p>The base code for this module is DL_MESO_DPD, the Dissipative Particle
Dynamics code from the mesoscopic simulation package <a class="reference external" href="http://www.ccp5.ac.uk/DL_MESO">DL_MESO</a>,
developed by M. Seaton at Daresbury Laboratory.
This open source code is available from STFC under both academic (free) and
commercial (paid) licenses. The module is to be used with <a class="reference external" href="http://www.ccp5.ac.uk/DL_MESO">DL_MESO</a>
in its last released version, version 2.6 (dating November 2015).</p>
<p>The present module requires the <a class="reference external" href="http://www.fz-juelich.de/ias/jsc/EN/Expertise/Support/Software/SIONlib/_node.html">SIONlib</a> library to be installed.
Its last released version is number 1.7.1 (dating November 2016).</p>
</div>
<div class="section" id="testing">
<h2><a class="toc-backref" href="#id7">Testing</a><a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>The version of DL_MESO_DPD including <a class="reference external" href="http://www.fz-juelich.de/ias/jsc/EN/Expertise/Support/Software/SIONlib/_node.html">SIONlib</a> (see below) is compiled using the
corresponding makefile (<code class="docutils literal"><span class="pre">Makefile-MPI</span></code>).
Two pre-processing flags can be used when compiling:
<code class="docutils literal"><span class="pre">-D</span> <span class="pre">DEBUG</span></code>, to print information for any SIONlib-related action, and
<code class="docutils literal"><span class="pre">-D</span> <span class="pre">STDTRAJ</span></code>, to recover the standard printing of trajectories as HISTORY* files.</p>
<p>The utility <code class="docutils literal"><span class="pre">format_history_sion.f90</span></code> is compiled with the available
Fortran90+MPI compiler, and using appropriate flags for the <a class="reference external" href="http://www.fz-juelich.de/ias/jsc/EN/Expertise/Support/Software/SIONlib/_node.html">SIONlib</a> library, e.g:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>mpifort -c -cpp format_history_sion.f90 `/home/user/sionlib/bin/sionconfig --cflags --f77 --mpi --threadsafe --64`
mpifort -o format_history_sion.exe format_history_sion.o `/home/user/sionlib/bin/sionconfig --libs --f77 --mpi --threadsafe --64`
</pre></div>
</div>
<p>and the executable must be in the same directory of the history.sion file.
It is assumed that <a class="reference external" href="http://www.fz-juelich.de/ias/jsc/EN/Expertise/Support/Software/SIONlib/_node.html">SIONlib</a> has been installed in the <cite>/home/user/sionlib/</cite>
directory, where of course the <cite>user</cite> name has to be adapted.
If the pre-processing flag <code class="docutils literal"><span class="pre">-D</span> <span class="pre">DEBUG</span></code> is used when compiling, the result of each read
statement is printed to the standard output and an eventual mismatch in the
number of read elements is signaled.</p>
<p>To test the writing/reading of the trajectories, the user can choose any
simulation run using DL_MESO_DPD, then analyze the trajectories with both
<code class="docutils literal"><span class="pre">format_history.f90</span></code> (which reads standard DL_MESO_DPD binary HISTORY*
files) and <code class="docutils literal"><span class="pre">format_history_sion.f90</span></code> (which reads the SIONlib-type history.sion file):
the formatted files so obtained, HISTORY*-F and sion*-F, respectively, should coincide.</p>
<p>However, for completeness, we provide the input files for a possible test:
the CONTROL file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Simple</span> <span class="n">test</span>

<span class="n">vol</span> <span class="mf">1000.0</span>
<span class="n">temperature</span> <span class="mf">1.0</span>
<span class="n">cutoff</span> <span class="mf">1.0</span>

<span class="n">timestep</span> <span class="mf">0.01</span>
<span class="n">steps</span> <span class="mi">1000</span>
<span class="n">equilibration</span> <span class="n">steps</span> <span class="mi">0</span>
<span class="n">traj</span>  <span class="mi">0</span>  <span class="mi">100</span>  <span class="mi">0</span>
<span class="n">stats</span> <span class="n">every</span> <span class="mi">100</span>
<span class="n">stack</span> <span class="n">size</span> <span class="mi">100</span>
<span class="nb">print</span> <span class="n">every</span> <span class="mi">100</span>
<span class="n">job</span> <span class="n">time</span> <span class="mf">1000.0</span>
<span class="n">close</span> <span class="n">time</span> <span class="mf">10.0</span>

<span class="n">ensemble</span> <span class="n">nvt</span> <span class="n">mdvv</span>

<span class="n">nfold</span>  <span class="mi">1</span>  <span class="mi">1</span>  <span class="mi">1</span>
<span class="k">global</span> <span class="n">bonds</span>

<span class="n">finish</span>
</pre></div>
</div>
<p>and the FIELD file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Simple</span> <span class="n">example</span>

<span class="n">SPECIES</span> <span class="mi">2</span>
<span class="n">A</span>  <span class="mf">1.0</span>  <span class="mf">0.0</span>  <span class="mi">0</span>  
<span class="n">B</span>  <span class="mf">1.0</span>  <span class="mf">0.0</span>  <span class="mi">0</span>  

<span class="n">MOLECULES</span> <span class="mi">1</span>
<span class="n">AB</span>
<span class="n">nummols</span> <span class="mi">1500</span>
<span class="n">beads</span> <span class="mi">2</span>
<span class="n">A</span>  <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">B</span>  <span class="mf">0.1</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">bonds</span> <span class="mi">1</span>
<span class="n">harm</span>  <span class="mi">1</span> <span class="mi">2</span> <span class="mf">10.0</span> <span class="mf">0.0</span>
<span class="n">finish</span>

<span class="n">INTERACTIONS</span> <span class="mi">2</span>
<span class="n">A</span>  <span class="n">A</span> <span class="n">dpd</span>   <span class="mf">25.0</span> <span class="mf">1.0</span> <span class="mf">4.0</span>
<span class="n">B</span>  <span class="n">B</span> <span class="n">dpd</span>   <span class="mf">25.0</span> <span class="mf">1.0</span> <span class="mf">4.0</span>

<span class="n">CLOSE</span>

</pre></div>
</div>
</div>
<div class="section" id="source-code">
<h2><a class="toc-backref" href="#id8">Source Code</a><a class="headerlink" href="#source-code" title="Permalink to this headline">¶</a></h2>
<p>A number of DL_MESO_DPD modules have to be slightly modified to use <a class="reference external" href="http://www.fz-juelich.de/ias/jsc/EN/Expertise/Support/Software/SIONlib/_node.html">SIONlib</a> when
writing the trajectories, namely: <code class="docutils literal"><span class="pre">variables.f90</span></code>, <code class="docutils literal"><span class="pre">constants.f90</span></code>,
<code class="docutils literal"><span class="pre">start_module.f90</span></code>, <code class="docutils literal"><span class="pre">dlmesodpd.f90</span></code>, <code class="docutils literal"><span class="pre">error_module.f90</span></code> and the
<code class="docutils literal"><span class="pre">Makefile-MPI</span></code>. As an example of the post-processing of a SIONlib-type
trajectory, we provide the formatting utility <code class="docutils literal"><span class="pre">format_history_sion.f90</span></code>,
analogous to <code class="docutils literal"><span class="pre">format_history.f90</span></code> (see <a class="reference internal" href="../format_dlmeso_dpd/readme.html#history-format-dpd"><span class="std std-ref">Formatting the HISTORY files of DL_MESO_DPD</span></a>):
it reads the SIONlib trajectory file (history.sion) and produces multiple formatted
trajectory files (sion*-F).</p>
<p>In the following we give the needed changes in the form of patches <a class="footnote-reference" href="#id3" id="id1">[1]</a>: in the
<cite>git diff</cite>, <cite>a</cite> is the branch with the standard version (version 2.6, revision
15 <a class="footnote-reference" href="#id4" id="id2">[2]</a>), <cite>b</cite> the SIONlib one.</p>
<p>The patch for <code class="docutils literal"><span class="pre">Makefile-MPI</span></code> is</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">diff --git a/Makefile-MPI b/Makefile-MPI
</span>index 462de59..0078f94 100644
--- a/Makefile-MPI
+++ b/Makefile-MPI
@@ -1,10 +1,13 @@
 MF=      Makefile
 
<span class="hll">+SCFLAGS = `/home/user/sionlib/bin/sionconfig --cflags --f77 --mpi --threadsafe --64`
</span><span class="hll">+SLFLAGS = `/home/user/sionlib/bin/sionconfig --libs --f77 --mpi --threadsafe --64`
</span><span class="hll">+
</span> FC=      mpifort
-FFLAGS=  -O3
<span class="hll">+FFLAGS=  -O3 -cpp
</span> LFLAGS=  $(FFLAGS)
 
-EXE=     dpd.exe
<span class="hll">+EXE=     dpd-MPI-sion.exe
</span> 
 VPATH=   ../DPD/
 
@@ -38,12 +41,12 @@ SRC= \
 OBJ=	$(SRC:.f90=.o)
 
 .f90.o:
-	$(FC) $(FFLAGS) -c $&lt;
<span class="hll">+	$(FC) $(FFLAGS) -c $&lt; $(SCFLAGS)
</span> 
 all:	$(EXE)
 
 $(EXE):	$(OBJ)
-	$(FC) $(LFLAGS) -o $@ $(OBJ)
<span class="hll">+	$(FC) $(LFLAGS) -o $@ $(OBJ) $(SLFLAGS)
</span> 
 $(OBJ):	$(MF)
 
</pre></div>
</td></tr></table></div>
<p>The patch for <code class="docutils literal"><span class="pre">variables.f90</span></code> is</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">diff --git a/variables.f90 b/variables.f90
</span>index 3aef25a..3f6a109 100644
--- a/variables.f90
+++ b/variables.f90
@@ -326,4 +326,18 @@ MODULE variables
 !         Allocated in config_module.f90          
       REAL(KIND=dp), ALLOCATABLE, SAVE, TARGET :: commsinbuf(:,:), commsoutbuf(:,:)
 
<span class="hll">+!     variables needed by SIONlib 
</span><span class="hll">+      INTEGER*8 sierr
</span><span class="hll">+      CHARACTER(len=255) :: filename 
</span><span class="hll">+      CHARACTER(len=255) :: newfname
</span><span class="hll">+      INTEGER:: nfiles
</span><span class="hll">+      INTEGER:: gComm, lComm, sid
</span><span class="hll">+      INTEGER:: fsblksize
</span><span class="hll">+      INTEGER*8 :: chunksize
</span><span class="hll">+      INTEGER*8 :: size, nelem
</span><span class="hll">+      INTEGER :: seof
</span><span class="hll">+      INTEGER :: buffer_i(6)
</span><span class="hll">+      REAL(KIND=dp) :: buffer_r(10)
</span><span class="hll">+      CHARACTER(LEN=8) :: buffer_c
</span><span class="hll">+      
</span> END MODULE
</pre></div>
</td></tr></table></div>
<p>The patch for  <code class="docutils literal"><span class="pre">constants.f90</span></code> is</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">diff --git a/constants.f90 b/constants.f90
</span>index 65bbee4..82c2641 100644
--- a/constants.f90
+++ b/constants.f90
@@ -13,5 +13,7 @@ MODULE constants
       REAL(KIND=dp), PARAMETER :: fkt=2.0_dp/3.0_dp
       REAL(KIND=dp), PARAMETER :: rt12=3.464101615377546_dp
       REAL(KIND=dp), PARAMETER :: langepsilon=1.0e-6_dp
<span class="hll">+!     for SIONlib
</span><span class="hll">+      INTEGER, PARAMETER :: nsion = 13
</span>       
 END MODULE
</pre></div>
</td></tr></table></div>
<p>The patch for <code class="docutils literal"><span class="pre">dlmesodpd.f90</span></code> is</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">diff --git a/dlmesodpd.f90 b/dlmesodpd.f90
</span>index 062c26c..90600f2 100644
--- a/dlmesodpd.f90
+++ b/dlmesodpd.f90
@@ -189,8 +189,15 @@ PROGRAM dlmesodpd
       END IF
 
 !     close files, deallocate arrays and close down MPI
-
<span class="hll">+#ifdef STDTRAJ
</span>       IF (ltraj) CLOSE (nhist)
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 3: close SIONlib file  
</span><span class="hll">+      IF (ltraj) call fsion_parclose_mpi(sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+      WRITE (nprint, *) &quot;sierr=&quot;, sierr , &quot;on idnode=&quot;, idnode
</span><span class="hll">+#endif
</span><span class="hll">+!!!
</span>       CALL free_memory
       IF (.NOT. l_scr) CLOSE (nprint)
       CALL exitcomms ()
</pre></div>
</td></tr></table></div>
<p>The patch for <code class="docutils literal"><span class="pre">error_module.f90</span></code> is</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">diff --git a/error_module.f90 b/error_module.f90
</span>index cb19b28..f8c3c3b 100644
--- a/error_module.f90
+++ b/error_module.f90
@@ -589,6 +589,11 @@ CONTAINS
         CASE (1198)
           WRITE (nprint,&quot;(/,1x,&#39;error: deallocation failure in field_module -&gt; plcfor_stoyanov&#39;)&quot;)
 
<span class="hll">+!      sionlib          
</span><span class="hll">+       CASE (1500) 
</span><span class="hll">+          WRITE (nprint,&quot;(/,1x,&#39;error: this version (using sionlib) does not support restart&#39;)&quot;)
</span><span class="hll">+       CASE (1501)
</span><span class="hll">+          WRITE (nprint,&quot;(/,1x,&#39;error: problem in writing SIONfile, mismatched number of items&#39;,i10)&quot;) value
</span>           
         CASE DEFAULT
           WRITE (nprint,&quot;(/,1x,&#39;error: undefined error code found&#39;)&quot;) 
@@ -605,7 +610,12 @@ CONTAINS
 !     close all i/o channels
 
         IF (idnode==0) CLOSE (nprint)
<span class="hll">+#ifdef STDTRAJ
</span>         CLOSE (nhist)
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib: close file
</span><span class="hll">+        IF (ltraj) call fsion_parclose_mpi(sid,sierr)
</span><span class="hll">+!!!
</span>         IF (idnode==0) CLOSE (nsave)
 
 !     shut down MPI and stop program
</pre></div>
</td></tr></table></div>
<p>The patch for <code class="docutils literal"><span class="pre">start_module.f90</span></code> is</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">diff --git a/start_module.f90 b/start_module.f90
</span>index a7f0233..81c3b24 100644
--- a/start_module.f90
+++ b/start_module.f90
@@ -95,6 +95,9 @@ CONTAINS
       INTEGER :: fail (4)
       INTEGER, ALLOCATABLE :: localmolmap(:)
 
<span class="hll">+!     SIONlib 0: set sionlib filename
</span><span class="hll">+      filename = &#39;history.sion&#39;
</span><span class="hll">+
</span> !     set restart filename
 
       WRITE (chan, &#39;(i6.6)&#39;) idnode
@@ -296,6 +299,10 @@ CONTAINS
 
         IF (nstep&gt;0) THEN
            
<span class="hll">+!!! SIONlib 1a: give error for resart
</span><span class="hll">+           CALL error (idnode, 1500, 1)
</span><span class="hll">+!!!
</span><span class="hll">+#ifdef STDTRAJ           
</span>            IF (nodes&gt;1) THEN
               OPEN (nhist, file=&#39;HISTORY&#39;//chan, access = &#39;sequential&#39;, form = &#39;unformatted&#39;, status = &#39;unknown&#39;,&amp;
                    &amp; position = &#39;append&#39;)
@@ -303,45 +310,184 @@ CONTAINS
               OPEN (nhist, file=&#39;HISTORY&#39;, access = &#39;sequential&#39;, form = &#39;unformatted&#39;, status = &#39;unknown&#39;,&amp;
                    &amp; position = &#39;append&#39;)
            END IF
-
<span class="hll">+#endif          
</span>         ELSE
 
<span class="hll">+!!! SIONlib 1b: define and open
</span><span class="hll">+           gcomm = MPI_COMM_WORLD
</span><span class="hll">+           lcomm = MPI_COMM_WORLD 
</span><span class="hll">+           fsblksize = -1
</span><span class="hll">+           chunksize = 100
</span><span class="hll">+           nfiles = 1
</span><span class="hll">+           call fsion_paropen_mpi(trim(filename),&#39;bw&#39;,nfiles, gComm,lComm, &amp;
</span><span class="hll">+                chunksize,fsblksize,idnode,newfname,sid)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+           WRITE (6,*) &quot;opened sionfile on node=&quot;,idnode ,&quot;; sid=&quot;,sid
</span><span class="hll">+           WRITE (6,*) &quot;input chunksize (if needed, will be internally corrected)=&quot;, chunksize, &quot;; fsblksize=&quot;, fsblksize
</span><span class="hll">+#endif
</span><span class="hll">+!!!
</span><span class="hll">+#ifdef STDTRAJ           
</span>           IF (nodes&gt;1) THEN
             OPEN (nhist, file=&#39;HISTORY&#39;//chan, access = &#39;sequential&#39;, form = &#39;unformatted&#39;, status = &#39;unknown&#39;)
           ELSE
             OPEN (nhist, file=&#39;HISTORY&#39;, access = &#39;sequential&#39;, form = &#39;unformatted&#39;, status = &#39;unknown&#39;)
           END IF
-
-
<span class="hll">+#endif          
</span>           IF (lgbnd .AND. idnode&gt;0) THEN
<span class="hll">+#ifdef STDTRAJ
</span>              WRITE (nhist) nspe, nmoldef, nusyst, nsyst, nbeads, 0
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2a: write into SION file
</span><span class="hll">+            nelem=6
</span><span class="hll">+            size=4
</span><span class="hll">+            buffer_i (1:6) = (/ nspe, nmoldef, nusyst, nsyst, nbeads, 0 /)
</span><span class="hll">+            call fsion_write(buffer_i,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+            IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+            WRITE (6,*) &quot;a written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!            
</span>           ELSE
<span class="hll">+#ifdef STDTRAJ
</span>              WRITE (nhist) nspe, nmoldef, nusyst, nsyst, nbeads, nbonds
-          END IF
-
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2b: write into SION file
</span><span class="hll">+            nelem=6
</span><span class="hll">+            size=4
</span><span class="hll">+            buffer_i (1:6) = (/ nspe, nmoldef, nusyst, nsyst, nbeads, nbonds /)
</span><span class="hll">+            call fsion_write(buffer_i,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+            IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+            WRITE (6,*) &quot;b written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!            
</span><span class="hll">+         END IF
</span><span class="hll">+#ifdef STDTRAJ
</span>          WRITE (nhist) dimx, dimy, dimz, volm
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2c: write into SION file
</span><span class="hll">+         nelem=4
</span><span class="hll">+         size=8
</span><span class="hll">+         buffer_r (1:4) = (/ dimx, dimy, dimz, volm /)
</span><span class="hll">+         call fsion_write(buffer_r,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+         IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+         WRITE (6,*) &quot;c written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!
</span><span class="hll">+#ifdef STDTRAJ
</span>          WRITE (nhist) keytrj, srftype*srfx, srftype*srfy, srftype*srfz
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2d: write into SION file
</span><span class="hll">+         nelem=4
</span><span class="hll">+         size=4
</span><span class="hll">+         buffer_i (1:4) = (/ keytrj, srftype*srfx, srftype*srfy, srftype*srfz /)
</span><span class="hll">+         call fsion_write(buffer_i,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+         IF (sierr.ne.nelem)  CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+         WRITE (6,*) &quot;d written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!
</span>        
 !      write species information
           DO i = 1, nspe
             k = (i * (i + 1)) / 2
             SELECT CASE (ktype (k))
             CASE (0:2)
<span class="hll">+#ifdef STDTRAJ
</span>                WRITE (nhist) namspe (i), amass (i), vvv (2, k), lfrzn (i)
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2e: write into SION file
</span><span class="hll">+              nelem=1
</span><span class="hll">+              size=8
</span><span class="hll">+              buffer_c = namspe (i)
</span><span class="hll">+              call fsion_write(buffer_c,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+              IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+              WRITE (6,*) &quot;e1 written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+              nelem=2
</span><span class="hll">+              size=8
</span><span class="hll">+              buffer_r (1:2) = (/ amass (i), vvv (2, k) /)              
</span><span class="hll">+              call fsion_write(buffer_r,size,nelem,sid,sierr)              
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+              IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+              WRITE (6,*) &quot;e2 written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif              
</span><span class="hll">+              nelem=1
</span><span class="hll">+              size=4
</span><span class="hll">+              buffer_i (1) = lfrzn (i)
</span><span class="hll">+              call fsion_write(buffer_i,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+              IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+              WRITE (6,*) &quot;e3 written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!                        
</span>            CASE (3)
<span class="hll">+#ifdef STDTRAJ
</span>               WRITE (nhist) namspe (i), amass (i), vvv (6, k), lfrzn (i)
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2f: write into SION file
</span><span class="hll">+              nelem=1
</span><span class="hll">+              size=8
</span><span class="hll">+              buffer_c = namspe (i)
</span><span class="hll">+              call fsion_write(buffer_c,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+              IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+              WRITE (6,*) &quot;f1 written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif              
</span><span class="hll">+              nelem=2
</span><span class="hll">+              size=8
</span><span class="hll">+              buffer_r (1:2) = (/ amass (i), vvv (6, k) /)              
</span><span class="hll">+              call fsion_write(buffer_r,size,nelem,sid,sierr)              
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+              IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+              WRITE (6,*) &quot;f2 written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif              
</span><span class="hll">+              nelem=1
</span><span class="hll">+              size=4
</span><span class="hll">+              buffer_i (1) = lfrzn (i)
</span><span class="hll">+              call fsion_write(buffer_i,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+              IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+              WRITE (6,*) &quot;f3 written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!                        
</span>            END SELECT
           END DO
 
 !      write molecule names
           IF (nmoldef&gt;0) THEN
             DO i = 1, nmoldef
<span class="hll">+#ifdef STDTRAJ
</span>                WRITE (nhist) nammol (i)
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2g: write into SION file
</span><span class="hll">+              nelem=1
</span><span class="hll">+              size=8
</span><span class="hll">+              buffer_c = nammol (i)
</span><span class="hll">+              call fsion_write(buffer_c,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+              IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+              WRITE (6,*) &quot;g written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!
</span>            END DO
           END IF
 
 !      write name of calculation
<span class="hll">+#ifdef STDTRAJ
</span>           WRITE (nhist) text
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2h: write into SION file
</span><span class="hll">+              nelem=1
</span><span class="hll">+              size=80
</span><span class="hll">+              call fsion_write(text,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+              IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+              WRITE (6,*) &quot;h written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif              
</span><span class="hll">+!!!
</span>           
 !      create map of local bead numbers to molecule numbers
           ALLOCATE (localmolmap (nbeads), STAT=fail(1))
@@ -351,7 +497,19 @@ CONTAINS
 !      write bead information (including molecule numbers)
           DO i = 1, nbeads
             imol = localmolmap(i)
<span class="hll">+#ifdef STDTRAJ
</span>             WRITE (nhist) lab (i), ltp (i), ltm (i), imol
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2i: write into SION file
</span><span class="hll">+            nelem=4
</span><span class="hll">+            size=4
</span><span class="hll">+            buffer_i (1:4) = (/ lab (i), ltp (i), ltm (i), imol /)
</span><span class="hll">+            call fsion_write(buffer_i,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+            IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+            WRITE (6,*) &quot;i written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!            
</span>          END DO
 
           DEALLOCATE (localmolmap, STAT=fail(1))
@@ -360,7 +518,19 @@ CONTAINS
 !      write bonds between beads
           IF (nbonds&gt;0 .AND. ((.NOT. lgbnd) .OR. idnode==0)) THEN
             DO j = 1, nbonds
<span class="hll">+#ifdef STDTRAJ
</span>                WRITE (nhist) bndtbl (j, 1), bndtbl (j, 2)
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2j: write into SION file
</span><span class="hll">+            nelem=2
</span><span class="hll">+            size=4
</span><span class="hll">+            buffer_i (1:2) = (/ bndtbl (j, 1), bndtbl (j, 2) /)
</span><span class="hll">+            call fsion_write(buffer_i,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+            IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+            WRITE (6,*) &quot;j written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!            
</span>            END DO
           END IF
 
</pre></div>
</td></tr></table></div>
<p>These changes only affect one subroutine (<code class="docutils literal"><span class="pre">start</span></code>) within the <code class="docutils literal"><span class="pre">start_module.f90</span></code>.
The user can either implement the changes shown above, or replace the
second part of the subroutine <code class="docutils literal"><span class="pre">start</span></code> with the file provided
(<a class="reference download internal" href="../../../../_downloads/part-of-start.f90" download=""><code class="xref download docutils literal"><span class="pre">downloadable</span> <span class="pre">version</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">second</span> <span class="pre">part</span> <span class="pre">of</span> <span class="pre">subroutine</span> <span class="pre">start</span></code></a>).</p>
<p>The patch for <code class="docutils literal"><span class="pre">statistics_module.f90</span></code> is</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll">diff --git a/statistics_module.f90 b/statistics_module.f90
</span>index e2d5e79..e283d16 100644
--- a/statistics_module.f90
+++ b/statistics_module.f90
@@ -11,6 +11,7 @@ MODULE statistics_module
 
       USE constants
       USE variables
<span class="hll">+      USE error_module
</span>       IMPLICIT none
 
 CONTAINS
@@ -621,41 +622,103 @@ CONTAINS
       REAL(KIND=dp) :: time
 
 !     write out data
-
<span class="hll">+#ifdef STDTRAJ
</span>       WRITE (nhist) time, REAL (nbeads, KIND=dp), dimx, dimy, dimz, shrdx, shrdy, shrdz
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2k: write into SION file
</span><span class="hll">+      nelem=8
</span><span class="hll">+      size=8
</span><span class="hll">+      buffer_r (1:8) = (/ time, REAL (nbeads, KIND=dp), dimx, dimy, dimz, shrdx, shrdy, shrdz /)
</span><span class="hll">+      call fsion_write(buffer_r,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+      IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+      WRITE (6,*) &quot;k written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!             
</span> 
       SELECT CASE (keytrj)
       CASE (0)
         ! positions
         DO i = 1, nbeads
<span class="hll">+#ifdef STDTRAJ
</span>            WRITE (nhist) REAL (lab(i), KIND=dp), xxx (i) + delx, yyy (i) + dely, zzz (i) + delz
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2l: write into SION file
</span><span class="hll">+          nelem=4
</span><span class="hll">+          size=8
</span><span class="hll">+          buffer_r (1:4) = (/ REAL (lab(i), KIND=dp), xxx (i) + delx, yyy (i) + dely, zzz (i) + delz /)
</span><span class="hll">+          call fsion_write(buffer_r,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+          IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+          WRITE (6,*) &quot;l written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!             
</span>         END DO
       CASE (1)
         ! positions and velocities
         DO i = 1, nbeads
<span class="hll">+#ifdef STDTRAJ
</span>            WRITE (nhist) REAL (lab(i), KIND=dp), xxx (i) + delx, yyy (i) + dely, zzz (i) + delz, &amp;
                &amp;vxx (i), vyy (i), vzz (i)
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2m: write into SION file
</span><span class="hll">+          nelem=7
</span><span class="hll">+          size=8
</span><span class="hll">+          buffer_r (1:7) = (/ REAL (lab(i), KIND=dp), xxx (i) + delx, yyy (i) + dely, zzz (i) + delz, &amp;
</span><span class="hll">+               &amp;vxx (i), vyy (i), vzz (i) /)
</span><span class="hll">+          call fsion_write(buffer_r,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+          IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+          WRITE (6,*) &quot;m written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!          
</span>         END DO
       CASE (2)
         ! positions, velocities and forces
         IF (itype==1) THEN
           DO i = 1, nbeads
<span class="hll">+#ifdef STDTRAJ
</span>              WRITE (nhist) REAL (lab(i), KIND=dp), xxx (i) + delx, yyy (i) + dely, zzz (i) + delz, &amp;
                  &amp;vxx (i), vyy (i), vzz (i), (fxx(i)+fvx(i)), (fyy(i)+fvy(i)), (fzz(i)+fvz(i))
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2n: write into SION file
</span><span class="hll">+            nelem=10
</span><span class="hll">+            size=8
</span><span class="hll">+            buffer_r (1:10) = (/ REAL (lab(i), KIND=dp), xxx (i) + delx, yyy (i) + dely, zzz (i) + delz, &amp;
</span><span class="hll">+                 &amp;vxx (i), vyy (i), vzz (i), (fxx(i)+fvx(i)), (fyy(i)+fvy(i)), (fzz(i)+fvz(i))  /)
</span><span class="hll">+            call fsion_write(buffer_r,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+            IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+            WRITE (6,*) &quot;n written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!                         
</span>           END DO
         ELSE
           DO i = 1, nbeads
<span class="hll">+#ifdef STDTRAJ
</span>              WRITE (nhist) REAL (lab(i), KIND=dp), xxx (i) + delx, yyy (i) + dely, zzz (i) + delz, &amp;
                   &amp;vxx (i), vyy (i), vzz (i), fxx (i), fyy (i), fzz (i)
<span class="hll">+#endif
</span><span class="hll">+!!! SIONlib 2p: write into SION file
</span><span class="hll">+            nelem=10
</span><span class="hll">+            size=8
</span><span class="hll">+            buffer_r (1:10) = (/ REAL (lab(i), KIND=dp), xxx (i) + delx, yyy (i) + dely, zzz (i) + delz, &amp;
</span><span class="hll">+                         &amp;vxx (i), vyy (i), vzz (i), fxx (i), fyy (i), fzz (i)  /)
</span><span class="hll">+            call fsion_write(buffer_r,size,nelem,sid,sierr)
</span><span class="hll">+#ifdef DEBUG
</span><span class="hll">+            IF (sierr.ne.nelem) CALL error (idnode, 1501, INT (sierr - nelem))
</span><span class="hll">+            WRITE (6,*) &quot;p written in sionfile on node=&quot;,idnode ,&quot;; # elements&quot;,sierr
</span><span class="hll">+#endif
</span><span class="hll">+!!!                         
</span>          END DO
         END IF
       END SELECT
 
 !     clear buffers in case of job failure
-
<span class="hll">+#ifdef STDTRAJ
</span>       ENDFILE (nhist)
       BACKSPACE (nhist)
-
<span class="hll">+#endif
</span>       RETURN
       END SUBROUTINE histout
 
</pre></div>
</td></tr></table></div>
<p>Also here the changes only affect one subroutine (<code class="docutils literal"><span class="pre">histout</span></code>) within the <code class="docutils literal"><span class="pre">statistics_module.f90</span></code>.
The user can either implement the changes shown above, or replace the
subroutine <code class="docutils literal"><span class="pre">histout</span></code> with the file provided
(<a class="reference download internal" href="../../../../_downloads/histout.f90" download=""><code class="xref download docutils literal"><span class="pre">downloadable</span> <span class="pre">version</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">subroutine</span> <span class="pre">histout</span></code></a>).</p>
<p>Finally, the formatting utility <code class="docutils literal"><span class="pre">format_history_sion.f90</span></code> is</p>
<div class="highlight-fortran"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">PROGRAM </span><span class="n">format_history_sion</span>
<span class="c">!***********************************************************************************</span>
<span class="c">!</span>
<span class="c">! module to format dl_meso HISTORY files written using SIONlib library</span>
<span class="c">!</span>
<span class="c">! authors - m. a. seaton &amp; s. chiacchiera, february 2017</span>
<span class="c">! adapted to use SIONlib: march 2018</span>
<span class="c">!**********************************************************************************</span>
  
<span class="k">IMPLICIT none</span>
<span class="k">INCLUDE</span> <span class="s2">&quot;mpif.h&quot;</span>
  
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">PARAMETER</span> <span class="kd">::</span> <span class="n">dp</span> <span class="o">=</span> <span class="nb">SELECTED_REAL_KIND</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">307</span><span class="p">)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">PARAMETER</span> <span class="kd">::</span> <span class="n">ntraj</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nuser</span><span class="o">=</span><span class="mi">5</span>

      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="kd">::</span> <span class="n">text</span>
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">namspe</span> <span class="p">(:),</span> <span class="n">nammol</span> <span class="p">(:)</span>
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chan</span>
      
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">ltp</span> <span class="p">(:),</span> <span class="n">ltm</span> <span class="p">(:),</span> <span class="n">mole</span> <span class="p">(:),</span>  <span class="n">beads</span> <span class="p">(:),</span> <span class="n">bonds</span> <span class="p">(:),</span> <span class="n">bndtbl</span> <span class="p">(:,:)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">nbdmol</span> <span class="p">(:),</span> <span class="n">nbomol</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">chain</span><span class="p">,</span> <span class="n">imol</span><span class="p">,</span> <span class="n">ioerror</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nmoldef</span><span class="p">,</span> <span class="n">ibond</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nspe</span><span class="p">,</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nusyst</span><span class="p">,</span> <span class="n">nsyst</span><span class="p">,</span> <span class="n">nbonds</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">numnodes</span><span class="p">,</span> <span class="n">numbond</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nummol</span><span class="p">,</span> <span class="n">lfrzn</span><span class="p">,</span> <span class="n">rnmol</span><span class="p">,</span> <span class="n">keytrj</span><span class="p">,</span> <span class="n">srfx</span><span class="p">,</span> <span class="n">srfy</span><span class="p">,</span> <span class="n">srfz</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nform</span>
      
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">nmol</span> <span class="p">(:)</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volm</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">shrdx</span><span class="p">,</span> <span class="n">shrdy</span><span class="p">,</span> <span class="n">shrdz</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">amass</span><span class="p">,</span> <span class="n">rcii</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="nb">time</span><span class="p">,</span> <span class="n">mbeads</span><span class="p">,</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fz</span>
      
      <span class="kt">LOGICAL</span> <span class="kd">::</span> <span class="n">eof</span><span class="p">,</span> <span class="n">lcomm</span><span class="p">,</span> <span class="n">lmcheck</span>
<span class="c">!     for SIONlib</span>
      <span class="kt">CHARACTER</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fname</span><span class="p">,</span> <span class="n">file_mode</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">numfiles</span><span class="p">,</span> <span class="n">ntasks</span><span class="p">,</span> <span class="n">fsblksize</span><span class="p">,</span> <span class="n">sid</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">globalranks</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">chunksizes</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span> <span class="kd">::</span> <span class="n">chunksize_input</span>
      <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span> <span class="kd">::</span> <span class="n">sierr</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nformsion</span>
      <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span> <span class="kd">::</span> <span class="n">size</span><span class="p">,</span> <span class="n">nelem</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">buffer_i</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">buffer_r</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="nb">LEN</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">buffer_c</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">rank</span><span class="p">,</span> <span class="n">chunknum</span>
      <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span> <span class="kd">::</span> <span class="n">posinchunk</span>
      <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">pos_d</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">chun_d</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">seof</span>
      <span class="k">PARAMETER</span> <span class="p">(</span><span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;history.sion&#39;</span><span class="p">)</span>
      <span class="k">PARAMETER</span> <span class="p">(</span><span class="n">file_mode</span><span class="o">=</span> <span class="s1">&#39;br&#39;</span><span class="p">)</span>
      
      <span class="c">! Switches for commenting and checking molecules</span>
      
      <span class="n">lcomm</span> <span class="o">=</span>   <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
      <span class="n">lmcheck</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
      
      <span class="c">! Get number of nodes </span>

      <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Number of nodes used in calculations ?&quot;</span>
      <span class="k">READ</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">numnodes</span>

      <span class="c">! Get chunksize used to write</span>
      <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Chunksize used to write history.sion?&quot;</span>
      <span class="k">READ</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">chunksize_input</span>
      
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">beads</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">),</span> <span class="n">bonds</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">))</span>

<span class="c">! SIONlib: Determine if history.sion file exists</span>
      <span class="k">INQUIRE</span> <span class="p">(</span><span class="k">file</span> <span class="o">=</span> <span class="n">fname</span><span class="p">,</span> <span class="n">EXIST</span> <span class="o">=</span> <span class="n">eof</span><span class="p">)</span>
      <span class="k">IF</span> <span class="p">(.</span><span class="nb">NOT</span><span class="p">.</span> <span class="n">eof</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: cannot find history.sion file&quot;</span>
         <span class="k">STOP</span>
<span class="k">      END IF</span>

<span class="c">! SIONlib: serial open</span>
      <span class="n">numfiles</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">fsblksize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">chunksizes</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">),</span> <span class="n">globalranks</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">))</span> 
      <span class="n">chunksizes</span> <span class="p">(:)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="n">globalranks</span> <span class="p">(:)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">call </span><span class="n">FSION_OPEN</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">file_mode</span><span class="p">,</span> <span class="n">ntasks</span><span class="p">,</span> <span class="n">numfiles</span><span class="p">,</span> <span class="p">&amp;</span>
           <span class="n">chunksizes</span><span class="p">,</span> <span class="n">fsblksize</span><span class="p">,</span> <span class="n">globalranks</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
      <span class="k">IF</span><span class="p">(</span><span class="n">ntasks</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">numnodes</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Number of tasks used to write is different from given! -&quot;</span><span class="p">,</span> <span class="n">ntasks</span>   
         <span class="k">STOP</span>
<span class="k">      END IF</span>
<span class="c">!      WRITE(6,*) &quot;chunksizes=&quot;, chunksizes !not read as it should. Why?</span>
      <span class="k">WRITE</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;fsblksize=&quot;</span><span class="p">,</span> <span class="n">fsblksize</span>
<span class="c">!      WRITE(6,*) &quot;globalranks=&quot;,globalranks !not read as it should. Why?</span>
      <span class="k">WRITE</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;sid=&quot;</span><span class="p">,</span> <span class="n">sid</span>
      <span class="c">! Set *by hand* the values of chunksizes and globalranks</span>
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntasks</span>
         <span class="n">globalranks</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
         <span class="n">chunksizes</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="k">DO WHILE</span> <span class="p">(</span><span class="n">chunksizes</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chunksize_input</span><span class="p">)</span> 
            <span class="n">chunksizes</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">chunksizes</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">fsblksize</span>
         <span class="k">END DO</span>
<span class="k">      END DO</span>
<span class="k">      WRITE</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(set by hand) chunksizes=&quot;</span><span class="p">,</span> <span class="n">chunksizes</span>
      <span class="k">WRITE</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(set by hand) globalranks=&quot;</span><span class="p">,</span> <span class="n">globalranks</span>

<span class="c">!     variables to track positions within the .sion file      </span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">pos_d</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">),</span> <span class="n">chun_d</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">))</span>      
      
      <span class="c">! Open the output files</span>
      <span class="n">nform</span> <span class="o">=</span> <span class="n">ntraj</span> <span class="o">+</span> <span class="n">numnodes</span>
      <span class="n">nformsion</span> <span class="o">=</span> <span class="n">nform</span> <span class="o">+</span> <span class="n">numnodes</span>       
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">numnodes</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="k">THEN</span>
<span class="k">            WRITE</span> <span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;(i6.6)&#39;</span><span class="p">)</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">OPEN</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;sion&#39;</span><span class="o">//</span><span class="n">chan</span><span class="o">//</span><span class="s1">&#39;-F&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
         <span class="k">ELSE</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;sion-F&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
         <span class="k">END IF</span>
<span class="k">      END DO</span>
      
<span class="c">! SIONlib:  reading the header of history.sion</span>
      <span class="c">! Here the number of beads, molecules and bonds are determined</span>
      <span class="c">! Arrays are filled with names of particles and molecules</span>

      <span class="n">numbond</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="n">seof</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="k">call </span><span class="n">fsion_feof</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">seof</span><span class="p">)</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">seof</span> <span class="o">/=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="cp">#ifdef DEBUG</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;rank &quot;</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;: End of file !&quot;</span>
<span class="cp">#endif</span>
            <span class="k">CYCLE</span>
<span class="k">         END IF</span>
<span class="k">         </span>
<span class="k">         </span><span class="n">rank</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
         <span class="n">chunknum</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">posinchunk</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="k">CALL </span><span class="n">FSION_SEEK</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">,</span> <span class="n">sierr</span><span class="p">)</span>
         
<span class="c">!     lines a and b</span>
         <span class="n">nelem</span><span class="o">=</span><span class="mi">6</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
         <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_i</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(a/b) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_i=&quot;</span><span class="p">,</span><span class="n">buffer_i</span>
         <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
         <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">nspe</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nmoldef</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">nusyst</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">nsyst</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
         <span class="k">END IF</span>
<span class="k">         </span><span class="n">nbeads</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
         <span class="n">nbonds</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
         <span class="c">!     line c</span>
         <span class="n">nelem</span><span class="o">=</span><span class="mi">4</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">8</span>
         <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_r</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(c) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_r(1:4)=&quot;</span><span class="p">,</span><span class="n">buffer_r</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
         <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
         <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">dimx</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dimy</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">dimz</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">volm</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
         <span class="k">END IF</span>
         <span class="c">!     line d</span>
         <span class="n">nelem</span><span class="o">=</span><span class="mi">4</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
         <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_i</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(d) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_i(1:4)=&quot;</span><span class="p">,</span><span class="n">buffer_i</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
         <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
         <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 
         <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">keytrj</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">srfx</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">srfy</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">srfz</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
         <span class="k">END IF</span>
<span class="k">         </span><span class="n">beads</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbeads</span>
         <span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbonds</span>
         <span class="n">numbond</span> <span class="o">=</span> <span class="n">numbond</span> <span class="o">+</span> <span class="n">nbonds</span>
         
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# nspe, nmoldef, nusyst, nsyst, nbeads, nbonds&quot;</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">nspe</span><span class="p">,</span> <span class="n">nmoldef</span><span class="p">,</span> <span class="n">nusyst</span><span class="p">,</span> <span class="n">nsyst</span><span class="p">,</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nbonds</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# dimx, dimy, dimz, volm&quot;</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">97</span><span class="p">)</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">volm</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# keytrj, srfx, srfy, srfz&quot;</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">keytrj</span><span class="p">,</span> <span class="n">srfx</span><span class="p">,</span> <span class="n">srfy</span><span class="p">,</span> <span class="n">srfz</span>

         <span class="n">chun_d</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">chunknum</span>
         <span class="n">pos_d</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">posinchunk</span>
      <span class="k">END DO</span> <span class="c">! end of loop over nodes</span>
<span class="c">!!!</span>
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">namspe</span> <span class="p">(</span><span class="n">nspe</span><span class="p">),</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">nmoldef</span><span class="p">))</span>
      <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">THEN </span>
<span class="k">         ALLOCATE</span> <span class="p">(</span><span class="n">ltp</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsyst</span><span class="p">),</span> <span class="n">ltm</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsyst</span><span class="p">),</span> <span class="n">mole</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsyst</span><span class="p">))</span>
         <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">nmol</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmoldef</span><span class="p">),</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmoldef</span><span class="p">),</span> <span class="n">nbomol</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmoldef</span><span class="p">))</span>
         <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">bndtbl</span> <span class="p">(</span><span class="n">numbond</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
      <span class="n">ENDIF</span>
      
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="n">rank</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
         <span class="n">chunknum</span> <span class="o">=</span> <span class="n">chun_d</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
         <span class="n">posinchunk</span> <span class="o">=</span> <span class="n">pos_d</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
         <span class="k">CALL </span><span class="n">FSION_SEEK</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">,</span> <span class="n">sierr</span><span class="p">)</span>
<span class="c">!!! </span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# SPECIES:&quot;</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# namspe, amass, rcii, lfrzn&quot;</span>
         
         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspe</span>
            <span class="c">!     line e</span>
            <span class="n">nelem</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">size</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">buffer_c</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span>
            <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_c</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(e1) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_c=&quot;</span><span class="p">,</span><span class="n">buffer_c</span>
            <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif               </span>
            <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 
            <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               </span><span class="n">namspe</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">buffer_c</span>
            <span class="k">END IF</span>
<span class="k">               </span>
<span class="k">            </span><span class="n">nelem</span><span class="o">=</span><span class="mi">2</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">8</span>
            <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_r</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(e2) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_r (1:2)=&quot;</span><span class="p">,</span><span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
            <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 
            <span class="n">amass</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">rcii</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="n">nelem</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
            <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_i</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(e3) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_i (1)=&quot;</span><span class="p">,</span><span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
            <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 
            <span class="n">lfrzn</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">)</span> <span class="n">namspe</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">amass</span><span class="p">,</span> <span class="n">rcii</span><span class="p">,</span> <span class="n">lfrzn</span>
         <span class="k">END DO</span>
<span class="k">         </span>
<span class="k">         IF</span> <span class="p">(</span><span class="n">nmoldef</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# MOLECULES:&quot;</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# nammol&quot;</span>

            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
               <span class="c">!     line g</span>
               <span class="n">nelem</span><span class="o">=</span><span class="mi">1</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">8</span>
               <span class="n">buffer_c</span> <span class="o">=</span> <span class="s1">&#39;        &#39;</span>
               <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_c</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
               <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                  </span><span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">buffer_c</span>
               <span class="k">END IF</span>
<span class="cp">#ifdef DEBUG</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(g) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_c=&quot;</span><span class="p">,</span><span class="n">buffer_c</span>
               <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
               <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 
               <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">END DO</span>
<span class="k">         END IF</span>

         <span class="c">!     line h</span>
         <span class="n">nelem</span><span class="o">=</span><span class="mi">1</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">80</span>
         <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;                                                                                &#39;</span>
         <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(h) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: text=&quot;</span><span class="p">,</span> <span class="n">text</span>
         <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
         <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 
         
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Simulation name:&quot;</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">text</span>

         <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            </span><span class="n">nummol</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">!counter for number of molecules      </span>
            <span class="n">ibond</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c">!counter for bonds</span>
         <span class="k">END IF</span>

         <span class="c">! Here one could close and open again the loop over nodes, as in the std </span>
         <span class="c">! version of the utility: in case, pos_d and chunk_d must be updated too</span>
         
      <span class="c">!     fill in arrays for beads and bonds</span>
         <span class="n">rank</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>

         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# BEADS:&quot;</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# global, species, molecule, chain&quot;</span>

         <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">THEN</span>
            <span class="c">!Build ltp, ltm, mole</span>
            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">beads</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
               <span class="c">!     line i</span>
               <span class="n">nelem</span> <span class="o">=</span> <span class="mi">4</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
               <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
               <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_i</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(i) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_i(1:4)=&quot;</span><span class="p">,</span><span class="n">buffer_i</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
               <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif </span>
               <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 

               <span class="n">global</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="n">species</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
               <span class="n">molecule</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
               <span class="n">chain</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>

               <span class="n">ltp</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span> <span class="o">=</span> <span class="n">species</span>
               <span class="n">ltm</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span> <span class="o">=</span> <span class="n">molecule</span>
               <span class="n">mole</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span> <span class="o">=</span> <span class="n">chain</span>
               <span class="n">nummol</span> <span class="o">=</span> <span class="nb">MAX</span> <span class="p">(</span><span class="n">nummol</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">chain</span> 
            <span class="k">END DO</span>
<span class="k">         ELSE</span>
<span class="k">            DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">beads</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
               <span class="c">!     line i</span>
               <span class="n">nelem</span> <span class="o">=</span> <span class="mi">4</span>
               <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
               <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
               <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_i</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(i) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_i(1:4)=&quot;</span><span class="p">,</span><span class="n">buffer_i</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
               <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
               <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 
               <span class="n">global</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="n">species</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
               <span class="n">molecule</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
               <span class="n">chain</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">chain</span> 
            <span class="k">END DO</span>
<span class="k">         </span><span class="n">ENDIF</span>
         
         <span class="k">IF</span> <span class="p">(</span><span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# BONDS:&quot;</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# extremes of the bond&quot;</span>

            <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">THEN</span>
               <span class="c">! Build bndtbl</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
                  <span class="n">ibond</span> <span class="o">=</span> <span class="n">ibond</span> <span class="o">+</span> <span class="mi">1</span>
                  <span class="c">!     line j</span>
                  <span class="n">nelem</span><span class="o">=</span><span class="mi">2</span>
                  <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
                  <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> 
                  <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_i</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(j) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_i(1:2)=&quot;</span><span class="p">,</span><span class="n">buffer_i</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
                  <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
                  <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 
                  <span class="n">bead1</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="n">bead2</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                  <span class="n">bndtbl</span> <span class="p">(</span><span class="n">ibond</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">bead1</span>
                  <span class="n">bndtbl</span> <span class="p">(</span><span class="n">ibond</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">bead2</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
               <span class="k">END DO</span>
<span class="k">            ELSE</span>
<span class="k">               DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
                  <span class="c">!     line j</span>
                  <span class="n">nelem</span><span class="o">=</span><span class="mi">2</span>
                  <span class="n">size</span><span class="o">=</span><span class="mi">4</span>
                  <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> 
                  <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_i</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(j) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_i(1:2)=&quot;</span><span class="p">,</span><span class="n">buffer_i</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span>
                  <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
                  <span class="k">CALL </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nelem</span><span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">)</span> 
                  <span class="n">bead1</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="n">bead2</span> <span class="o">=</span> <span class="n">buffer_i</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
               <span class="k">END DO</span>
<span class="k">            END IF</span>
<span class="k">         END IF</span>
<span class="k">         </span><span class="n">chun_d</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">chunknum</span>
         <span class="n">pos_d</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">posinchunk</span>
         
      <span class="k">END DO</span> <span class="c">! over nodes</span>

      <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">THEN</span>
      <span class="c">! determine numbers of molecules, beads and bonds per molecule type</span>
         <span class="n">nmol</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
         <span class="n">nbdmol</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">nbomol</span> <span class="o">=</span> <span class="mi">0</span> 
         <span class="n">chain</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">imol</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">!necessary to avoid out of bounds</span>
         
         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsyst</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">mole</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/=</span> <span class="n">chain</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               </span><span class="n">chain</span> <span class="o">=</span> <span class="n">mole</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
               <span class="n">imol</span> <span class="o">=</span> <span class="n">ltm</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
               <span class="n">nmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">nmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0_dp</span>
            <span class="k">END IF</span>
<span class="k">            IF</span> <span class="p">(</span><span class="n">imol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="k">END DO</span>

<span class="k">         DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numbond</span>
            <span class="n">imol</span> <span class="o">=</span> <span class="n">ltm</span> <span class="p">(</span><span class="n">bndtbl</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">nbomol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbomol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="k">END DO</span>
<span class="k">            </span>
<span class="k">         DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
            <span class="n">rnmol</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">nmol</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">rnmol</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               </span><span class="n">nbdmol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">rnmol</span>
               <span class="n">nbomol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbomol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">rnmol</span>
            <span class="k">END IF</span>
<span class="k">         END DO</span>

         <span class="c">! Write to std output the arrays built</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Check of beads: i, ltp(i), ltm(i), mole(i)&quot;</span>
         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsyst</span>
            <span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">i</span><span class="p">,</span> <span class="n">ltp</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ltm</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">mole</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
         <span class="k">END DO</span>

         <span class="c">!Check of molecule beads and numbers</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">nmoldef</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Check of molecules: nammol(i), nbdmol(i), nbomol(i), nmol(i)&quot;</span>
            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">nbomol</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">NINT</span><span class="p">(</span><span class="n">nmol</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">END DO</span>
<span class="k">            WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Total number of molecules = &quot;</span><span class="p">,</span><span class="n">nummol</span>
         <span class="k">END IF</span>

         <span class="c">! Write to std output bndtbl</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">numbond</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Check of bonds: bndbtl(i,1), bndbtl(i,2)&quot;</span>
            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numbond</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">bndtbl</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bndtbl</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">END DO</span>
<span class="k">         END IF</span>
<span class="k">      END IF</span>

      <span class="c">!reading trajectories </span>
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>

         <span class="n">seof</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
         
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# --- TRAJECTORIES --- (key =&quot;</span><span class="p">,</span> <span class="n">keytrj</span><span class="p">,</span><span class="s2">&quot;)&quot;</span>
         <span class="k">SELECT CASE</span> <span class="p">(</span><span class="n">keytrj</span><span class="p">)</span>
         <span class="k">CASE</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# mglobal, x, y, z&quot;</span>
         <span class="k">CASE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# mglobal, x, y, z, vx, vy, vz&quot;</span>
         <span class="k">CASE</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# mglobal, x, y, z, vx, vy, vz, fx, fy, fz&quot;</span>
         <span class="k">END SELECT</span>
<span class="k">         </span>
<span class="k">         </span><span class="n">rank</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
         <span class="n">chunknum</span> <span class="o">=</span> <span class="n">chun_d</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
         <span class="n">posinchunk</span> <span class="o">=</span> <span class="n">pos_d</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>         
         <span class="k">CALL </span><span class="n">FSION_SEEK</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">chunknum</span><span class="p">,</span> <span class="n">posinchunk</span><span class="p">,</span> <span class="n">sierr</span><span class="p">)</span>
<span class="c">!!!         </span>
         <span class="k">DO WHILE</span> <span class="p">(.</span><span class="n">true</span><span class="p">.)</span>

            <span class="k">call </span><span class="n">fsion_feof</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">seof</span><span class="p">)</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">seof</span> <span class="o">/=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="cp">#ifdef DEBUG</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: End of file !&quot;</span>
<span class="cp">#endif</span>
               <span class="k">IF</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                  PRINT</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;ERROR: cannot find trajectory data in history.sion file&#39;</span>
                  <span class="k">STOP</span>
<span class="k">               END IF</span>
<span class="k">               EXIT</span>
<span class="k">            END IF</span>
            
            <span class="c">! line k </span>
            <span class="n">nelem</span><span class="o">=</span><span class="mi">8</span>
            <span class="n">size</span><span class="o">=</span><span class="mi">8</span>
            <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_r</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(k) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_r(1:8)=&quot;</span><span class="p">,</span><span class="n">buffer_r</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
            <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
            <span class="nb">time</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mbeads</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">dimx</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">dimy</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">dimz</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">shrdx</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">shrdy</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>
            <span class="n">shrdz</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span>
            <span class="c">!</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# time, mbeads, dimx, dimy, dimz, shrdx, shrdy, shrdz&quot;</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">98</span><span class="p">)</span> <span class="nb">time</span><span class="p">,</span> <span class="n">mbeads</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">shrdx</span><span class="p">,</span> <span class="n">shrdy</span><span class="p">,</span> <span class="n">shrdz</span>
                        
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
            
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# snapshot number:&quot;</span><span class="p">,</span> <span class="n">k</span>
            
            <span class="n">nbeads</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">mbeads</span><span class="p">)</span>
            
            <span class="k">SELECT CASE</span> <span class="p">(</span><span class="n">keytrj</span><span class="p">)</span>
            <span class="k">CASE</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="c">! line l</span>
                  <span class="n">nelem</span><span class="o">=</span><span class="mi">4</span>
                  <span class="n">size</span><span class="o">=</span><span class="mi">8</span>
                  <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
                  <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_r</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(l) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_r(1:4)=&quot;</span><span class="p">,</span><span class="n">buffer_r</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
                  <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
                  <span class="n">mglobal</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="n">x</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                  <span class="n">y</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                  <span class="n">z</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                  <span class="c">!</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
               <span class="k">END DO</span>
<span class="k">            CASE</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="c">! line m</span>
                  <span class="n">nelem</span><span class="o">=</span><span class="mi">7</span>
                  <span class="n">size</span><span class="o">=</span><span class="mi">8</span>
                  <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
                  <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_r</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(m) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_r(1:7)=&quot;</span><span class="p">,</span><span class="n">buffer_r</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
                  <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
                  <span class="n">mglobal</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="n">x</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                  <span class="n">y</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                  <span class="n">z</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                  <span class="n">vx</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                  <span class="n">vy</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                  <span class="n">vz</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>
                  <span class="c">!</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span>
               <span class="k">END DO</span>
<span class="k">            CASE</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="c">! line n and p</span>
                  <span class="n">nelem</span><span class="o">=</span><span class="mi">10</span>
                  <span class="n">size</span><span class="o">=</span><span class="mi">8</span>
                  <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
                  <span class="k">CALL </span><span class="n">FSION_READ</span><span class="p">(</span><span class="n">buffer_r</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">nelem</span><span class="p">,</span><span class="n">sid</span><span class="p">,</span><span class="n">sierr</span><span class="p">)</span>
<span class="cp">#ifdef DEBUG</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;(l) in sion file, rank &quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="s2">&quot;: buffer_r(1:10)=&quot;</span><span class="p">,</span><span class="n">buffer_r</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span>
                  <span class="k">CALL </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="cp">#endif</span>
                  <span class="n">mglobal</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                  <span class="n">x</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                  <span class="n">y</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                  <span class="n">z</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                  <span class="n">vx</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                  <span class="n">vy</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                  <span class="n">vz</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>
                  <span class="n">fx</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span>
                  <span class="n">fy</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">9</span><span class="p">)</span>
                  <span class="n">fz</span> <span class="o">=</span> <span class="n">buffer_r</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                  <span class="c">!</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fz</span>
               <span class="k">END DO</span>
<span class="k">            END SELECT</span>
<span class="k">            </span>
<span class="k">         END DO</span>
<span class="k">      END DO</span>
      
      <span class="c">! close the output files</span>
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">CLOSE</span> <span class="p">(</span><span class="n">nformsion</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">END DO</span>

<span class="c">! SIONlib serial close</span>
      <span class="k">call </span><span class="n">FSION_CLOSE</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">sierr</span><span class="p">)</span>
      <span class="k">CLOSE</span> <span class="p">(</span><span class="n">nformsion</span><span class="p">)</span>

<span class="cp">#ifdef DEBUG</span>
      <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;The final chunknumbers and positions within chunks are:&quot;</span>
      <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;chun_d=&quot;</span><span class="p">,</span> <span class="n">chun_d</span>
      <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;pos_d=&quot;</span><span class="p">,</span> <span class="n">pos_d</span>
<span class="cp">#endif</span>
      
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">beads</span><span class="p">,</span> <span class="n">bonds</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">namspe</span><span class="p">,</span> <span class="n">nammol</span><span class="p">)</span>
      <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">ltm</span><span class="p">,</span> <span class="n">mole</span><span class="p">,</span> <span class="n">nmol</span><span class="p">,</span> <span class="n">nbdmol</span><span class="p">,</span> <span class="n">bndtbl</span><span class="p">,</span> <span class="n">nbomol</span><span class="p">)</span>
<span class="c">! SIONlib related quantities</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">chunksizes</span><span class="p">,</span> <span class="n">globalranks</span><span class="p">,</span> <span class="n">pos_d</span><span class="p">,</span> <span class="n">chun_d</span><span class="p">)</span>

<span class="mi">99</span>    <span class="k">FORMAT</span><span class="p">(</span><span class="n">f10</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="n">p</span><span class="p">,</span><span class="mi">9</span><span class="p">(</span><span class="n">e13</span><span class="p">.</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">))</span>
<span class="mi">98</span>    <span class="k">FORMAT</span><span class="p">(</span><span class="mi">8</span><span class="p">(</span><span class="n">f10</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">))</span>
<span class="mi">97</span>    <span class="k">FORMAT</span><span class="p">(</span><span class="mi">4</span><span class="p">(</span><span class="n">f10</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">))</span>
<span class="mi">96</span>    <span class="k">FORMAT</span><span class="p">(</span><span class="n">A9</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">,</span><span class="mi">2</span><span class="p">(</span><span class="n">f10</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">),</span><span class="n">I2</span><span class="p">)</span>

    <span class="k">CONTAINS</span>

<span class="k">      SUBROUTINE </span><span class="n">DETERMINE_POS</span> <span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
<span class="c">!***********************************************************************************</span>
<span class="c">! routine to determine the position in the .sion file at each write statement </span>
<span class="c">!</span>
<span class="c">! author - s. chiacchiera, march 2018</span>
<span class="c">!***********************************************************************************</span>
<span class="c">! It is assumed that each rank has its chunks numbered as 0, 1, etc</span>
        <span class="k">IMPLICIT none</span>
<span class="k">        </span><span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span> <span class="p">(</span><span class="n">OUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">rank</span>
        <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span> <span class="p">(</span><span class="n">INOUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chunk</span>
        <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="k">INTENT</span> <span class="p">(</span><span class="n">INOUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pos</span>
        <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nbytes</span>
        <span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span> <span class="kd">::</span> <span class="n">pos_try</span>
        <span class="k">IF</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="n">chunksizes</span> <span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">THEN</span>
<span class="k">           WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;error: too large record (hint: increase chunksize)&quot;</span>
           <span class="k">STOP</span>
<span class="k">        END IF</span>
<span class="k">        </span><span class="n">pos_try</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">nbytes</span>
        <span class="k">IF</span> <span class="p">(</span><span class="n">pos_try</span> <span class="o">&lt;=</span> <span class="n">chunksizes</span> <span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">THEN </span>
<span class="k">           </span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos_try</span>
        <span class="k">ELSE</span>
<span class="k">           </span><span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">+</span> <span class="mi">1</span>
           <span class="n">pos</span> <span class="o">=</span> <span class="n">nbytes</span>
        <span class="k">END IF</span>
<span class="k">        RETURN</span>
<span class="k">      END SUBROUTINE </span><span class="n">DETERMINE_POS</span>

      <span class="k">SUBROUTINE </span><span class="n">READ_CHECK</span> <span class="p">(</span><span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span><span class="p">)</span>
<span class="c">!***********************************************************************************</span>
<span class="c">! routine to signal eventual mismatch when reading the .sion file</span>
<span class="c">!</span>
<span class="c">! author - s. chiacchiera, march 2018</span>
<span class="c">!***********************************************************************************</span>

        <span class="k">IMPLICIT none</span>
<span class="k">        </span><span class="kt">INTEGER</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="k">INTENT</span> <span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sierr</span><span class="p">,</span> <span class="n">nelem</span>
        <span class="k">IF</span> <span class="p">(</span><span class="n">sierr</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">nelem</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">           WRITE</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;error: number of elements read differs from expected! mismatch is &quot;</span><span class="p">,</span> <span class="n">sierr</span><span class="o">-</span><span class="n">nelem</span>
           <span class="k">STOP</span>
<span class="k">        END IF</span>
<span class="k">      END SUBROUTINE </span><span class="n">READ_CHECK</span>
     
<span class="k">END PROGRAM </span><span class="n">format_history_sion</span>
</pre></div>
</td></tr></table></div>
<p><strong>Additional information</strong></p>
<p>Using the modifications proposed above, the trajectories will be written
by DL_MESO_DPD in the SIONlib format (history.sion file). For comparison
purposes, the standard HISTORY* files can be also written at the same time,
using the <code class="docutils literal"><span class="pre">-D</span> <span class="pre">STDTRAJ</span></code> flag for compilation in <code class="docutils literal"><span class="pre">Makefile-MPI</span></code>.</p>
<p>To be able to use SIONlib, the writing statements for which the records are formed
by inhomogeneous items (e.g., two 8-byte strings and a 4-byte integer)
have to be split into different records, hence the increased number of write/read statements.
To help the reader, comments have been added to label all
the SIONlib-related commands, namely: &#8220;SIONlib 0, 1a, 1b, 2a, 2b, ..., 2p, 3&#8221;.
The writing statements are labelled &#8220;2a, 2b, etc&#8221;, and each one
corresponds to the writing of single record in the standard version of
DL_MESO_DPD. The SIONlib file definition, opening and closing statements have been labelled 0, 1 and 3 in the comments.</p>
<p>Important SIONlib variables:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">fsblksize</span></code>: file system block size in bytes. If set to -1, it is read by
SIONlib. (Typically, this value is 4096.)</li>
<li><code class="docutils literal"><span class="pre">chunksize</span></code>: size in bytes of the data written by a task in a single write
call. It is internally increased by SIONlib to the next multiple of the
filesystem block size. (For DL_MESO_DPD, the largest record has size 80 bytes, hence we choose
chunksize = 100, which, typically, will be internally increased to 4096.)</li>
<li><code class="docutils literal"><span class="pre">nfiles</span></code>: number of physical files produced by SIONlib (set to 1 here).</li>
</ul>
<p><strong>Acknowledgements</strong></p>
<p>We are very grateful to Dr. Wolfgang Frings for kind support concerning the usage of
the Fortran version of <a class="reference external" href="http://www.fz-juelich.de/ias/jsc/EN/Expertise/Support/Software/SIONlib/_node.html">SIONlib</a>.</p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>If patching is done with GNU <cite>patch</cite> command, the <cite>-l</cite> option (ignoring
whitespaces) has to be active.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>On <a class="reference external" href="https://ccpforge.cse.rl.ac.uk/gf/">CCPForge</a>, a software development framework where, in particular,
the different versions of DL_MESO_DPD are stored,
version 2.6 in its revision 15 corresponds to the commit number
48e9a42a51f4cb450eb9c39dcbf6eb4a38c7cd32.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/ecam_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using SIONlib (parallel I/O library) to write/read HISTORY files in DL_MESO_DPD</a><ul>
<li><a class="reference internal" href="#purpose-of-module">Purpose of Module</a></li>
<li><a class="reference internal" href="#background-information">Background Information</a></li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#source-code">Source Code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../../hierarchical-strategy/simple_one-component_melts/coarse-graining/readme.html"
                        title="previous chapter">Coarse-Graining: A Component of the Hierarchical Equilibration Strategy for Polymer Melts</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../../../best-practices/index.html"
                        title="next chapter">Scientific Software Best Practices</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/Meso-Multi-Scale-Modelling-Modules/modules/DL_MESO_DPD/sionlib_dlmeso_dpd/readme.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../best-practices/index.html" title="Scientific Software Best Practices"
             >next</a> |</li>
        <li class="right" >
          <a href="../../hierarchical-strategy/simple_one-component_melts/coarse-graining/readme.html" title="Coarse-Graining: A Component of the Hierarchical Equilibration Strategy for Polymer Melts"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">E-CAM Software Library 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Meso- and Multi-scale Modules</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, E-CAM Centre of Excellence.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.
    </div>
  </body>
</html>