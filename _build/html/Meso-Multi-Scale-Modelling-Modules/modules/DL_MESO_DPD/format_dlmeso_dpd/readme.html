<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Formatting the HISTORY files of DL_MESO_DPD &#8212; E-CAM Software Library 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/ecam_logo.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Autocorrelation functions of charge dipole moments in DL_MESO_DPD" href="../dipole_af_dlmeso_dpd/readme.html" />
    <link rel="prev" title="Analysis of charge dipole moments in DL_MESO_DPD" href="../dipole_dlmeso_dpd/readme.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../dipole_af_dlmeso_dpd/readme.html" title="Autocorrelation functions of charge dipole moments in DL_MESO_DPD"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../dipole_dlmeso_dpd/readme.html" title="Analysis of charge dipole moments in DL_MESO_DPD"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">E-CAM Software Library 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Meso- and Multi-scale Modules</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="formatting-the-history-files-of-dl-meso-dpd">
<span id="history-format-dpd"></span><h1>Formatting the HISTORY files of DL_MESO_DPD<a class="headerlink" href="#formatting-the-history-files-of-dl-meso-dpd" title="Permalink to this headline">¶</a></h1>
<div class="sidebar">
<p class="first sidebar-title">Software Technical Information</p>
<dl class="last docutils">
<dt>Language</dt>
<dd>FORTRAN 90</dd>
<dt>Licence</dt>
<dd>BSD</dd>
<dt>Documentation Tool</dt>
<dd>RST and LaTex-generated .pdf</dd>
<dt>Application Documentation</dt>
<dd><a class="reference download internal" href="../../../../_downloads/manhis.pdf" download=""><code class="xref download docutils literal"><span class="pre">Click</span> <span class="pre">to</span> <span class="pre">download</span> <span class="pre">the</span> <span class="pre">manual</span></code></a> with more details</dd>
<dt>Relevant Training Material</dt>
<dd>See the Testing section</dd>
</dl>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#purpose-of-module" id="id1">Purpose of Module</a></li>
<li><a class="reference internal" href="#background-information" id="id2">Background Information</a></li>
<li><a class="reference internal" href="#testing" id="id3">Testing</a></li>
<li><a class="reference internal" href="#source-code" id="id4">Source Code</a></li>
</ul>
</div>
<div class="section" id="purpose-of-module">
<h2><a class="toc-backref" href="#id1">Purpose of Module</a><a class="headerlink" href="#purpose-of-module" title="Permalink to this headline">¶</a></h2>
<p>This module <code class="docutils literal"><span class="pre">format_history.f90</span></code> is a post-processing
utility for DL_MESO_DPD, the Dissipative Particle Dynamics (DPD) code from the <a class="reference external" href="http://www.ccp5.ac.uk/DL_MESO">DL_MESO</a> package.</p>
<p>It converts the trajectory (HISTORY) files from <em>unformatted</em> to a
human readable form, (optionally) including explicative comments about all the
quantities. This module is mainly for learning/checking purposes.
The first aim is to help the user to check that the
system was prepared as intended (e.g., showing all the bead properties and
initial positions, all the bonds etc).
The idea is to use it on small systems when familiarizing with the structure
of input files needed for the simulation.
Secondly, it can be used as a starting point for a user-defined analysis
of trajectories.</p>
</div>
<div class="section" id="background-information">
<h2><a class="toc-backref" href="#id2">Background Information</a><a class="headerlink" href="#background-information" title="Permalink to this headline">¶</a></h2>
<p>The base code for this module is DL_MESO_DPD, the Dissipative Particle
Dynamics code from the mesoscopic simulation package <a class="reference external" href="http://www.ccp5.ac.uk/DL_MESO">DL_MESO</a>,
developed by M. Seaton at Daresbury Laboratory.
This open source code is available from STFC under both academic (free) and
commercial (paid) licenses. The module is to be used with DL_MESO
in its last released version, version 2.6 (dating November 2015).</p>
</div>
<div class="section" id="testing">
<h2><a class="toc-backref" href="#id3">Testing</a><a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>The present module is compiled with the available Fortran90 compiler, e.g.:</p>
<p><code class="docutils literal"><span class="pre">gfortran</span> <span class="pre">-o</span> <span class="pre">format.exe</span> <span class="pre">format_history.f90</span></code></p>
<p>and the executable must be in the same directory of the HISTORY* files to be
analyzed. To test the module, run the simulation with the <em>toy</em> input files given in the following.
(Note that these files contain commented lines as suggestions for further tests.)
For the CONTROL file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Simple</span> <span class="n">test</span>

<span class="n">volume</span> <span class="mf">3.0</span>  <span class="mf">3.0</span>  <span class="mf">3.0</span>
<span class="n">temperature</span> <span class="mf">1.0</span>
<span class="n">cutoff</span> <span class="mf">1.0</span>

<span class="n">timestep</span> <span class="mf">0.01</span>
<span class="n">steps</span> <span class="mi">6</span>
<span class="n">equilibration</span> <span class="n">steps</span> <span class="mi">2</span>
<span class="n">traj</span>  <span class="mi">2</span>  <span class="mi">2</span>  <span class="mi">0</span>
<span class="n">stats</span> <span class="n">every</span> <span class="mi">2</span>
<span class="n">stack</span> <span class="n">size</span> <span class="mi">2</span>
<span class="nb">print</span> <span class="n">every</span> <span class="mi">2</span>
<span class="n">job</span> <span class="n">time</span> <span class="mf">100.0</span>
<span class="n">close</span> <span class="n">time</span> <span class="mf">10.0</span>

<span class="c1">#surface shear y</span>
<span class="c1">#surface frozen  x</span>
<span class="c1">#surface hard  x</span>

<span class="n">ensemble</span> <span class="n">nvt</span> <span class="n">mdvv</span>

<span class="n">finish</span>
</pre></div>
</div>
<p>and for the FIELD file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Simple</span> <span class="n">test</span>

<span class="n">SPECIES</span> <span class="mi">3</span>
<span class="n">A</span>    <span class="mf">1.0</span>  <span class="mf">0.0</span>   <span class="mi">1</span>   <span class="mi">0</span>
<span class="n">B</span>    <span class="mf">1.0</span>  <span class="mf">0.0</span>   <span class="mi">0</span>   <span class="mi">0</span>
<span class="n">C</span>    <span class="mf">1.0</span>  <span class="mf">0.0</span>   <span class="mi">0</span>   <span class="mi">0</span> 

<span class="n">MOLECULES</span> <span class="mi">2</span>
<span class="n">AB</span>
<span class="n">nummols</span> <span class="mi">1</span>
<span class="n">beads</span> <span class="mi">2</span>
<span class="n">A</span>    <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">B</span>    <span class="mf">0.1</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">bonds</span> <span class="mi">1</span>
<span class="n">harm</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mf">5.0</span> <span class="mf">0.0</span>
<span class="n">finish</span>
<span class="n">AC</span>
<span class="n">nummols</span> <span class="mi">1</span>
<span class="n">beads</span> <span class="mi">2</span>
<span class="n">A</span>    <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">C</span>    <span class="mf">0.1</span> <span class="mf">0.0</span> <span class="mf">0.0</span>
<span class="n">bonds</span> <span class="mi">1</span>
<span class="n">harm</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mf">3.0</span> <span class="mf">0.0</span>
<span class="n">finish</span>

<span class="n">INTERACTIONS</span> <span class="mi">3</span>
<span class="n">A</span>    <span class="n">A</span>    <span class="n">dpd</span> <span class="mf">25.0</span> <span class="mf">1.0</span> <span class="mf">4.5</span>
<span class="n">B</span>    <span class="n">B</span>    <span class="n">dpd</span> <span class="mf">25.0</span> <span class="mf">1.0</span> <span class="mf">4.5</span>
<span class="n">C</span>    <span class="n">C</span>    <span class="n">dpd</span> <span class="mf">25.0</span> <span class="mf">1.0</span> <span class="mf">4.5</span>

<span class="c1">#EXTERNAL</span>
<span class="c1">#shear  3.0  0.0  0.0</span>

<span class="n">CLOSE</span>
</pre></div>
</div>
<p>After analyzing the trajectories, for a serial run (i.e., a single HISTORY
file) and for both <code class="docutils literal"><span class="pre">lcomm</span></code> and <code class="docutils literal"><span class="pre">lmcheck</span></code> set to <code class="docutils literal"><span class="pre">.TRUE.</span></code>,
this output should be printed on the screen</p>
<div class="highlight-default"><div class="highlight"><pre><span></span> Number of nodes used in calculations ?
 # Check of beads: i, ltp(i), ltm(i), mole(i)
           1           1           0           0
           2           1           1           1
           3           2           1           1
           4           1           2           2
           5           3           2           2
 # Check of molecules: nammol(i), nbdmol(i), nbomol(i), nmol(i)
 AB                 2           1           1
 AC                 2           1           1
 # Total number of molecules =            2
 # Check of bonds: bndbtl(i,1), bndbtl(i,2)
           2           3
           4           5
</pre></div>
</div>
<p>and the HISTORY-F file should be</p>
<div class="highlight-default"><div class="highlight"><pre><span></span> <span class="c1"># nspe, nmoldef, nusyst, nsyst, nbeads, nbonds</span>
           <span class="mi">3</span>           <span class="mi">2</span>           <span class="mi">1</span>           <span class="mi">5</span>           <span class="mi">5</span>           <span class="mi">2</span>
 <span class="c1"># dimx, dimy, dimz, volm</span>
     <span class="mf">3.000</span>        <span class="mf">3.000</span>        <span class="mf">3.000</span>       <span class="mf">27.000</span>
 <span class="c1"># keytrj, srfx, srfy, srfz</span>
           <span class="mi">0</span>           <span class="mi">0</span>           <span class="mi">0</span>           <span class="mi">0</span>
 <span class="c1"># SPECIES:</span>
 <span class="c1"># namspe, amass, rcii, lfrzn</span>
 <span class="n">A</span>               <span class="mf">1.000</span>        <span class="mf">1.000</span>    <span class="mi">0</span>
 <span class="n">B</span>               <span class="mf">1.000</span>        <span class="mf">1.000</span>    <span class="mi">0</span>
 <span class="n">C</span>               <span class="mf">1.000</span>        <span class="mf">1.000</span>    <span class="mi">0</span>
 <span class="c1"># MOLECULES:</span>
 <span class="c1"># nammol</span>
 <span class="n">AB</span>      
 <span class="n">AC</span>      
 <span class="c1"># Simulation name:</span>
 <span class="n">Simple</span> <span class="n">test</span>                                                                     
 <span class="c1"># BEADS:</span>
 <span class="c1"># global, species, molecule, chain</span>
           <span class="mi">1</span>           <span class="mi">1</span>           <span class="mi">0</span>           <span class="mi">0</span>
           <span class="mi">2</span>           <span class="mi">1</span>           <span class="mi">1</span>           <span class="mi">1</span>
           <span class="mi">3</span>           <span class="mi">2</span>           <span class="mi">1</span>           <span class="mi">1</span>
           <span class="mi">4</span>           <span class="mi">1</span>           <span class="mi">2</span>           <span class="mi">2</span>
           <span class="mi">5</span>           <span class="mi">3</span>           <span class="mi">2</span>           <span class="mi">2</span>
 <span class="c1"># BONDS:</span>
 <span class="c1"># extremes of the bond</span>
           <span class="mi">2</span>           <span class="mi">3</span>
           <span class="mi">4</span>           <span class="mi">5</span>
 <span class="c1"># --- TRAJECTORIES --- (key =           0 )</span>
 <span class="c1"># mglobal, x, y, z</span>
 <span class="c1"># time, mbeads, dimx, dimy, dimz, shrdx, shrdy, shrdz</span>
     <span class="mf">0.000</span>        <span class="mf">5.000</span>        <span class="mf">3.000</span>        <span class="mf">3.000</span>        <span class="mf">3.000</span>        <span class="mf">0.000</span>        <span class="mf">0.000</span>        <span class="mf">0.000</span>
 <span class="c1"># snapshot number:           1</span>
       <span class="mf">1.0</span>   <span class="mf">1.471873E+00</span>    <span class="mf">1.525203E+00</span>    <span class="mf">1.507395E+00</span>
       <span class="mf">2.0</span>   <span class="mf">1.364570E+00</span>    <span class="mf">2.228593E+00</span>    <span class="mf">2.475293E+00</span>
       <span class="mf">3.0</span>   <span class="mf">1.300679E+00</span>    <span class="mf">2.256132E+00</span>    <span class="mf">2.340013E+00</span>
       <span class="mf">4.0</span>   <span class="mf">2.306000E+00</span>    <span class="mf">2.535871E+00</span>    <span class="mf">2.718987E-01</span>
       <span class="mf">5.0</span>   <span class="mf">2.292338E+00</span>    <span class="mf">2.576789E+00</span>    <span class="mf">2.972781E-01</span>
 <span class="c1"># time, mbeads, dimx, dimy, dimz, shrdx, shrdy, shrdz</span>
     <span class="mf">0.020</span>        <span class="mf">5.000</span>        <span class="mf">3.000</span>        <span class="mf">3.000</span>        <span class="mf">3.000</span>        <span class="mf">0.000</span>        <span class="mf">0.000</span>        <span class="mf">0.000</span>
 <span class="c1"># snapshot number:           2</span>
       <span class="mf">1.0</span>   <span class="mf">1.443747E+00</span>    <span class="mf">1.550407E+00</span>    <span class="mf">1.514791E+00</span>
       <span class="mf">2.0</span>   <span class="mf">1.403396E+00</span>    <span class="mf">2.234155E+00</span>    <span class="mf">2.504685E+00</span>
       <span class="mf">3.0</span>   <span class="mf">1.294301E+00</span>    <span class="mf">2.264003E+00</span>    <span class="mf">2.309210E+00</span>
       <span class="mf">4.0</span>   <span class="mf">2.296760E+00</span>    <span class="mf">2.511000E+00</span>    <span class="mf">2.881257E-01</span>
       <span class="mf">5.0</span>   <span class="mf">2.297256E+00</span>    <span class="mf">2.563023E+00</span>    <span class="mf">2.750665E-01</span>
 <span class="c1"># time, mbeads, dimx, dimy, dimz, shrdx, shrdy, shrdz</span>
     <span class="mf">0.040</span>        <span class="mf">5.000</span>        <span class="mf">3.000</span>        <span class="mf">3.000</span>        <span class="mf">3.000</span>        <span class="mf">0.000</span>        <span class="mf">0.000</span>        <span class="mf">0.000</span>
 <span class="c1"># snapshot number:           3</span>
       <span class="mf">1.0</span>   <span class="mf">1.415620E+00</span>    <span class="mf">1.575610E+00</span>    <span class="mf">1.522186E+00</span>
       <span class="mf">2.0</span>   <span class="mf">1.444185E+00</span>    <span class="mf">2.239136E+00</span>    <span class="mf">2.537687E+00</span>
       <span class="mf">3.0</span>   <span class="mf">1.285960E+00</span>    <span class="mf">2.272457E+00</span>    <span class="mf">2.274797E+00</span>
       <span class="mf">4.0</span>   <span class="mf">2.287877E+00</span>    <span class="mf">2.466031E+00</span>    <span class="mf">3.080055E-01</span>
       <span class="mf">5.0</span>   <span class="mf">2.301818E+00</span>    <span class="mf">2.569355E+00</span>    <span class="mf">2.492021E-01</span>
 <span class="c1"># time, mbeads, dimx, dimy, dimz, shrdx, shrdy, shrdz</span>
     <span class="mf">0.040</span>        <span class="mf">5.000</span>        <span class="mf">3.000</span>        <span class="mf">3.000</span>        <span class="mf">3.000</span>        <span class="mf">0.000</span>        <span class="mf">0.000</span>        <span class="mf">0.000</span>
</pre></div>
</div>
</div>
<div class="section" id="source-code">
<h2><a class="toc-backref" href="#id4">Source Code</a><a class="headerlink" href="#source-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-fortran"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">PROGRAM </span><span class="n">format_history</span>
<span class="c">!***********************************************************************************</span>
<span class="c">!</span>
<span class="c">! module to format dl_meso HISTORY files</span>
<span class="c">!</span>
<span class="c">! authors - m. a. seaton &amp; s. chiacchiera, february 2017</span>
<span class="c">!</span>
<span class="c">!**********************************************************************************</span>
<span class="k">IMPLICIT none</span>
<span class="k">      </span><span class="kt">INTEGER</span><span class="p">,</span> <span class="k">PARAMETER</span> <span class="kd">::</span> <span class="n">dp</span> <span class="o">=</span> <span class="nb">SELECTED_REAL_KIND</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">307</span><span class="p">)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">PARAMETER</span> <span class="kd">::</span> <span class="n">ntraj</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">nuser</span><span class="o">=</span><span class="mi">5</span>

      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="kd">::</span> <span class="n">text</span><span class="p">,</span> <span class="n">a2</span>
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">namspe</span> <span class="p">(:),</span> <span class="n">nammol</span> <span class="p">(:)</span>
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chan</span>
      <span class="kt">CHARACTER</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a1</span>
      
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">ltp</span> <span class="p">(:),</span> <span class="n">ltm</span> <span class="p">(:),</span> <span class="n">mole</span> <span class="p">(:),</span>  <span class="n">beads</span> <span class="p">(:),</span> <span class="n">bonds</span> <span class="p">(:),</span> <span class="n">bndtbl</span> <span class="p">(:,:)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">nbdmol</span> <span class="p">(:),</span> <span class="n">nbomol</span> <span class="p">(:)</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">chain</span><span class="p">,</span> <span class="n">imol</span><span class="p">,</span> <span class="n">ioerror</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">nmoldef</span><span class="p">,</span> <span class="n">ibond</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nspe</span><span class="p">,</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nusyst</span><span class="p">,</span> <span class="n">nsyst</span><span class="p">,</span> <span class="n">nbonds</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">numnodes</span><span class="p">,</span> <span class="n">numbond</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nummol</span><span class="p">,</span> <span class="n">lfrzn</span><span class="p">,</span> <span class="n">rnmol</span><span class="p">,</span> <span class="n">keytrj</span><span class="p">,</span> <span class="n">srfx</span><span class="p">,</span> <span class="n">srfy</span><span class="p">,</span> <span class="n">srfz</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span>
      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">nform</span>
      
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">),</span> <span class="k">ALLOCATABLE</span> <span class="kd">::</span> <span class="n">nmol</span> <span class="p">(:)</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volm</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">shrdx</span><span class="p">,</span> <span class="n">shrdy</span><span class="p">,</span> <span class="n">shrdz</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">amass</span><span class="p">,</span> <span class="n">rcii</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="nb">time</span><span class="p">,</span> <span class="n">mbeads</span><span class="p">,</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fz</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r4</span>
      
      <span class="kt">LOGICAL</span> <span class="kd">::</span> <span class="n">eof</span><span class="p">,</span> <span class="n">lcomm</span><span class="p">,</span> <span class="n">lmcheck</span>

      <span class="c">! Switches for commenting and checking molecules</span>
      
      <span class="n">lcomm</span> <span class="o">=</span>   <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
      <span class="n">lmcheck</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>

      <span class="c">! Get number of nodes </span>

      <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Number of nodes used in calculations ?&quot;</span>
      <span class="k">READ</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">numnodes</span>
      
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">beads</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">),</span> <span class="n">bonds</span> <span class="p">(</span><span class="n">numnodes</span><span class="p">))</span>
      
      <span class="c">! Determine if HISTORY files exist</span>

      <span class="k">IF</span> <span class="p">(</span><span class="n">numnodes</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         INQUIRE</span> <span class="p">(</span><span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY000000&#39;</span><span class="p">,</span> <span class="n">EXIST</span> <span class="o">=</span> <span class="n">eof</span><span class="p">)</span>
      <span class="k">ELSE</span>
<span class="k">         INQUIRE</span> <span class="p">(</span><span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="p">,</span> <span class="n">EXIST</span> <span class="o">=</span> <span class="n">eof</span><span class="p">)</span>
      <span class="k">END IF</span>
<span class="k">      IF</span> <span class="p">(.</span><span class="nb">NOT</span><span class="p">.</span> <span class="n">eof</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">         WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: cannot find HISTORY files&quot;</span>
         <span class="k">STOP</span>
<span class="k">      END IF</span>

      <span class="c">! Open the output files</span>
      <span class="n">nform</span> <span class="o">=</span> <span class="n">ntraj</span> <span class="o">+</span> <span class="n">numnodes</span> 
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;(i6.6)&#39;</span><span class="p">)</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">numnodes</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="k">THEN</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="o">//</span><span class="n">chan</span><span class="o">//</span><span class="s2">&quot;-F&quot;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
         <span class="k">ELSE</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="o">//</span><span class="s2">&quot;-F&quot;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
         <span class="k">END IF</span>
<span class="k">      END DO</span>
         
      <span class="c">! First reading, where the number of beads, molecules and bonds are determined</span>
      <span class="c">! Arrays are filled with names of particles and molecules</span>
      <span class="c">! If multiple HISTORY files are present, it is checked they are compatible</span>
      
      <span class="n">numbond</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;(i6.6)&#39;</span><span class="p">)</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">numnodes</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="o">//</span><span class="n">chan</span><span class="p">,</span> <span class="nb">access</span> <span class="o">=</span> <span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
         <span class="k">ELSE</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="p">,</span> <span class="nb">access</span> <span class="o">=</span> <span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
         <span class="k">END IF</span>
<span class="k">         </span>
<span class="k">         IF</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">nspe</span><span class="p">,</span> <span class="n">nmoldef</span><span class="p">,</span> <span class="n">nusyst</span><span class="p">,</span> <span class="n">nsyst</span><span class="p">,</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nbonds</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">volm</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">keytrj</span><span class="p">,</span> <span class="n">srfx</span><span class="p">,</span> <span class="n">srfy</span><span class="p">,</span> <span class="n">srfz</span>
         <span class="k">ELSE</span>
<span class="k">            READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nbonds</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r4</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">n1</span> <span class="o">/=</span> <span class="n">nspe</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n2</span> <span class="o">/=</span> <span class="n">nmoldef</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n3</span> <span class="o">/=</span> <span class="n">nusyst</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n4</span> <span class="o">/=</span> <span class="n">nsyst</span> <span class="p">&amp;</span>
                <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">r1</span> <span class="o">/=</span> <span class="n">dimx</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">r2</span> <span class="o">/=</span> <span class="n">dimy</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">r3</span> <span class="o">/=</span> <span class="n">dimz</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">r4</span> <span class="o">/=</span> <span class="n">volm</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>
               <span class="k">STOP</span>
<span class="k">            </span><span class="n">ENDIF</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">n1</span> <span class="o">/=</span> <span class="n">keytrj</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n2</span> <span class="o">/=</span> <span class="n">srfx</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n3</span> <span class="o">/=</span> <span class="n">srfy</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">n4</span> <span class="o">/=</span> <span class="n">srfz</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>
               <span class="k">STOP</span>
<span class="k">            </span><span class="n">ENDIF</span>
         <span class="n">ENDIF</span>

         <span class="n">beads</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbeads</span>
         <span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbonds</span>
         <span class="n">numbond</span> <span class="o">=</span> <span class="n">numbond</span> <span class="o">+</span> <span class="n">nbonds</span>
         
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# nspe, nmoldef, nusyst, nsyst, nbeads, nbonds&quot;</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">nspe</span><span class="p">,</span> <span class="n">nmoldef</span><span class="p">,</span> <span class="n">nusyst</span><span class="p">,</span> <span class="n">nsyst</span><span class="p">,</span> <span class="n">nbeads</span><span class="p">,</span> <span class="n">nbonds</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# dimx, dimy, dimz, volm&quot;</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">97</span><span class="p">)</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">volm</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# keytrj, srfx, srfy, srfz&quot;</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">keytrj</span><span class="p">,</span> <span class="n">srfx</span><span class="p">,</span> <span class="n">srfy</span><span class="p">,</span> <span class="n">srfz</span>
      <span class="k">END DO</span> <span class="c">! loop over nodes</span>
               
      <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">namspe</span> <span class="p">(</span><span class="n">nspe</span><span class="p">),</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">nmoldef</span><span class="p">))</span>
      <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">THEN </span>
<span class="k">         ALLOCATE</span> <span class="p">(</span><span class="n">ltp</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsyst</span><span class="p">),</span> <span class="n">ltm</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsyst</span><span class="p">),</span> <span class="n">mole</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsyst</span><span class="p">))</span>
         <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">nmol</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmoldef</span><span class="p">),</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmoldef</span><span class="p">),</span> <span class="n">nbomol</span> <span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmoldef</span><span class="p">))</span>
         <span class="k">ALLOCATE</span> <span class="p">(</span><span class="n">bndtbl</span> <span class="p">(</span><span class="n">numbond</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
      <span class="n">ENDIF</span>
      
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# SPECIES:&quot;</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# namspe, amass, rcii, lfrzn&quot;</span>
         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspe</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">namspe</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">amass</span><span class="p">,</span> <span class="n">rcii</span><span class="p">,</span> <span class="n">lfrzn</span>
            <span class="k">ELSE</span>
<span class="k">               READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">a1</span><span class="p">,</span> <span class="n">amass</span><span class="p">,</span> <span class="n">rcii</span><span class="p">,</span> <span class="n">lfrzn</span>
               <span class="k">IF</span> <span class="p">(</span><span class="n">a1</span> <span class="o">/=</span> <span class="n">namspe</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="k">THEN</span>
<span class="k">                  WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>
                  <span class="k">STOP</span>
<span class="k">               </span><span class="n">ENDIF</span>
            <span class="n">ENDIF</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">)</span> <span class="n">namspe</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">amass</span><span class="p">,</span> <span class="n">rcii</span><span class="p">,</span> <span class="n">lfrzn</span>
         <span class="k">END DO</span>

<span class="k">         IF</span> <span class="p">(</span><span class="n">nmoldef</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# MOLECULES:&quot;</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# nammol&quot;</span>
            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
               <span class="k">IF</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                  READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
               <span class="k">ELSE</span>
<span class="k">                  READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">a1</span>
                  <span class="k">IF</span> <span class="p">(</span><span class="n">a1</span> <span class="o">/=</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="k">THEN</span>
<span class="k">                     WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>
                     <span class="k">STOP</span>
<span class="k">                  </span><span class="n">ENDIF</span>
               <span class="k">END IF</span>
<span class="k">               WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">END DO</span>
<span class="k">         END IF</span>

<span class="k">         IF</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">text</span>
         <span class="k">ELSE</span>
<span class="k">            READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">a2</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">a2</span> <span class="o">/=</span> <span class="n">text</span><span class="p">)</span> <span class="k">THEN </span>
<span class="k">               WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: HISTORY files do not refer to the same system!&quot;</span>            
               <span class="k">STOP</span>
<span class="k">            </span><span class="n">ENDIF</span>
         <span class="n">ENDIF</span>
            
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Simulation name:&quot;</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">text</span>

      <span class="n">ENDDO</span> <span class="c">! end of loop over nodes</span>
               
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">CLOSE</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">END DO</span>
      
      <span class="c">! Second reading, where (if required) arrays are filled with properties</span>
      <span class="c">! of beads and molecules. Then, the snapshots of trajectories are read.</span>

      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="s1">&#39;(i6.6)&#39;</span><span class="p">)</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">numnodes</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="o">//</span><span class="n">chan</span><span class="p">,</span> <span class="nb">access</span> <span class="o">=</span> <span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
         <span class="k">ELSE</span>
<span class="k">            OPEN</span> <span class="p">(</span><span class="n">ntraj</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="s1">&#39;HISTORY&#39;</span><span class="p">,</span> <span class="nb">access</span> <span class="o">=</span> <span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
         <span class="k">END IF     </span>
<span class="k">      </span>
<span class="k">         READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!nspe, nmoldef, nusyst, nsyst, nbeads, nbonds</span>
         <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!dimx, dimy, dimz, volm</span>
         <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!keytrj, srfx, srfy, srfz</span>

         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspe</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!namspe (i), amass, rcii, lfrzn</span>
         <span class="k">END DO</span>
<span class="k">         </span>
<span class="k">         DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!nammol (i)</span>
         <span class="k">END DO</span>
<span class="k">         </span>
<span class="k">         READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c">!text</span>
      <span class="k">END DO</span>

<span class="k">            </span>

<span class="k">      </span><span class="n">nummol</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">!counter for number of molecules      </span>
      <span class="n">ibond</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c">!counter for bonds</span>
      
      <span class="c">!     fill in arrays for beads and bonds</span>
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# BEADS:&quot;</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# global, species, molecule, chain&quot;</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">THEN</span>
            <span class="c">!Build ltp, ltm, mole</span>
            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">beads</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
               <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">chain</span>
               <span class="n">ltp</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span> <span class="o">=</span> <span class="n">species</span>
               <span class="n">ltm</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span> <span class="o">=</span> <span class="n">molecule</span>
               <span class="n">mole</span> <span class="p">(</span><span class="n">global</span><span class="p">)</span> <span class="o">=</span> <span class="n">chain</span>
               <span class="n">nummol</span> <span class="o">=</span> <span class="nb">MAX</span> <span class="p">(</span><span class="n">nummol</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">chain</span> 
            <span class="k">END DO</span>
<span class="k">         ELSE</span>
<span class="k">            DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">beads</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
               <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">chain</span>         
               <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">global</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">chain</span> 
            <span class="k">END DO</span>
<span class="k">         </span><span class="n">ENDIF</span>
         
         <span class="k">IF</span> <span class="p">(</span><span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# BONDS:&quot;</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# extremes of the bond&quot;</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">THEN</span>
               <span class="c">! Build bndtbl</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
                  <span class="n">ibond</span> <span class="o">=</span> <span class="n">ibond</span> <span class="o">+</span> <span class="mi">1</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
                  <span class="n">bndtbl</span> <span class="p">(</span><span class="n">ibond</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">bead1</span>
                  <span class="n">bndtbl</span> <span class="p">(</span><span class="n">ibond</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">bead2</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
               <span class="k">END DO</span>
<span class="k">            ELSE</span>
<span class="k">               DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bonds</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">bead1</span><span class="p">,</span> <span class="n">bead2</span>
               <span class="k">END DO</span>
<span class="k">            END IF</span>
<span class="k">         END IF</span>
<span class="k">            </span>
<span class="k">      END DO</span> <span class="c">! over nodes</span>
      
      <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">THEN</span>
      <span class="c">! determine numbers of molecules, beads and bonds per molecule type</span>
         <span class="n">nmol</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
         <span class="n">nbdmol</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">nbomol</span> <span class="o">=</span> <span class="mi">0</span> 
         <span class="n">chain</span> <span class="o">=</span> <span class="mi">0</span>
         <span class="n">imol</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">!necessary to avoid out of bounds</span>
         
         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsyst</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">mole</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/=</span> <span class="n">chain</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               </span><span class="n">chain</span> <span class="o">=</span> <span class="n">mole</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
               <span class="n">imol</span> <span class="o">=</span> <span class="n">ltm</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
               <span class="n">nmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">nmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0_dp</span>
            <span class="k">END IF</span>
<span class="k">            IF</span> <span class="p">(</span><span class="n">imol</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="k">END DO</span>

<span class="k">         DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numbond</span>
            <span class="n">imol</span> <span class="o">=</span> <span class="n">ltm</span> <span class="p">(</span><span class="n">bndtbl</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">nbomol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbomol</span> <span class="p">(</span><span class="n">imol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
         <span class="k">END DO</span>
<span class="k">            </span>
<span class="k">         DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
            <span class="n">rnmol</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">nmol</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">rnmol</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               </span><span class="n">nbdmol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">rnmol</span>
               <span class="n">nbomol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">nbomol</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">rnmol</span>
            <span class="k">END IF</span>
<span class="k">         END DO</span>

         <span class="c">! Write to std output the arrays built</span>
         <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Check of beads: i, ltp(i), ltm(i), mole(i)&quot;</span>
         <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsyst</span>
            <span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">i</span><span class="p">,</span> <span class="n">ltp</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">ltm</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">mole</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
         <span class="k">END DO</span>

         <span class="c">!Check of molecule beads and numbers</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">nmoldef</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Check of molecules: nammol(i), nbdmol(i), nbomol(i), nmol(i)&quot;</span>
            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmoldef</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">nammol</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">nbdmol</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">nbomol</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">NINT</span><span class="p">(</span><span class="n">nmol</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">END DO</span>
<span class="k">            WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Total number of molecules = &quot;</span><span class="p">,</span><span class="n">nummol</span>
         <span class="k">END IF</span>

         <span class="c">! Write to std output bndtbl</span>
         <span class="k">IF</span> <span class="p">(</span><span class="n">numbond</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">            WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# Check of bonds: bndbtl(i,1), bndbtl(i,2)&quot;</span>
            <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numbond</span>
               <span class="k">WRITE</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">bndtbl</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bndtbl</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">END DO</span>
<span class="k">         END IF</span>
<span class="k">      END IF</span>

      <span class="c">!reading trajectories </span>
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
    
         <span class="n">eof</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
         <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
      
         <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# --- TRAJECTORIES --- (key =&quot;</span><span class="p">,</span> <span class="n">keytrj</span><span class="p">,</span><span class="s2">&quot;)&quot;</span>
         <span class="k">SELECT CASE</span> <span class="p">(</span><span class="n">keytrj</span><span class="p">)</span>
         <span class="k">CASE</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# mglobal, x, y, z&quot;</span>
         <span class="k">CASE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# mglobal, x, y, z, vx, vy, vz&quot;</span>
         <span class="k">CASE</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# mglobal, x, y, z, vx, vy, vz, fx, fy, fz&quot;</span>
         <span class="k">END SELECT</span>
<span class="k">         </span>
<span class="k">         DO WHILE</span> <span class="p">(.</span><span class="n">true</span><span class="p">.)</span>
            <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">IOSTAT</span><span class="o">=</span><span class="n">ioerror</span><span class="p">)</span> <span class="nb">time</span><span class="p">,</span> <span class="n">mbeads</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">shrdx</span><span class="p">,</span> <span class="n">shrdy</span><span class="p">,</span> <span class="n">shrdz</span>
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# time, mbeads, dimx, dimy, dimz, shrdx, shrdy, shrdz&quot;</span>
            <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">98</span><span class="p">)</span> <span class="nb">time</span><span class="p">,</span> <span class="n">mbeads</span><span class="p">,</span> <span class="n">dimx</span><span class="p">,</span> <span class="n">dimy</span><span class="p">,</span> <span class="n">dimz</span><span class="p">,</span> <span class="n">shrdx</span><span class="p">,</span> <span class="n">shrdy</span><span class="p">,</span> <span class="n">shrdz</span>
            
            <span class="k">IF</span> <span class="p">(</span><span class="n">ioerror</span><span class="o">/=</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">               </span><span class="n">eof</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
               <span class="k">IF</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">THEN</span>
<span class="k">                  PRINT</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;ERROR: cannot find trajectory data in HISTORY files&#39;</span>
                  <span class="k">STOP</span>
<span class="k">               END IF</span>
<span class="k">               EXIT</span>
<span class="k">            END IF</span>
<span class="k">            </span>
<span class="k">            </span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
            
            <span class="k">IF</span> <span class="p">(</span><span class="n">lcomm</span><span class="p">)</span> <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;# snapshot number:&quot;</span><span class="p">,</span> <span class="n">k</span>
            
            <span class="n">nbeads</span> <span class="o">=</span> <span class="nb">NINT</span> <span class="p">(</span><span class="n">mbeads</span><span class="p">)</span>
            
            <span class="k">SELECT CASE</span> <span class="p">(</span><span class="n">keytrj</span><span class="p">)</span>
            <span class="k">CASE</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
               <span class="k">END DO</span>
<span class="k">            CASE</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span>
               <span class="k">END DO</span>
<span class="k">            CASE</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
               <span class="k">DO </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbeads</span>
                  <span class="k">READ</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fz</span>
                  <span class="k">WRITE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span> <span class="n">mglobal</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">,</span> <span class="n">vz</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">fz</span>
               <span class="k">END DO</span>
<span class="k">            END SELECT</span>
<span class="k">            </span>
<span class="k">         END DO</span>
<span class="k">      END DO</span>
         
      <span class="c">! Close the trajectory files</span>
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">CLOSE</span> <span class="p">(</span><span class="n">ntraj</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">END DO</span>

      <span class="c">! close the output files</span>
      <span class="k">DO </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numnodes</span>
         <span class="k">CLOSE</span> <span class="p">(</span><span class="n">nform</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">END DO</span>
<span class="k">               </span>
<span class="k">      DEALLOCATE</span> <span class="p">(</span><span class="n">beads</span><span class="p">,</span> <span class="n">bonds</span><span class="p">)</span>
      <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">namspe</span><span class="p">,</span> <span class="n">nammol</span><span class="p">)</span>
      <span class="k">IF</span> <span class="p">(</span><span class="n">lmcheck</span><span class="p">)</span> <span class="k">DEALLOCATE</span> <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">ltm</span><span class="p">,</span> <span class="n">mole</span><span class="p">,</span> <span class="n">nmol</span><span class="p">,</span> <span class="n">nbdmol</span><span class="p">,</span> <span class="n">bndtbl</span><span class="p">,</span> <span class="n">nbomol</span><span class="p">)</span>

<span class="mi">99</span>    <span class="k">FORMAT</span><span class="p">(</span><span class="n">f10</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="n">p</span><span class="p">,</span><span class="mi">9</span><span class="p">(</span><span class="n">e13</span><span class="p">.</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">))</span>
<span class="mi">98</span>    <span class="k">FORMAT</span><span class="p">(</span><span class="mi">8</span><span class="p">(</span><span class="n">f10</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">))</span>
<span class="mi">97</span>    <span class="k">FORMAT</span><span class="p">(</span><span class="mi">4</span><span class="p">(</span><span class="n">f10</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">))</span>
<span class="mi">96</span>    <span class="k">FORMAT</span><span class="p">(</span><span class="n">A9</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">,</span><span class="mi">2</span><span class="p">(</span><span class="n">f10</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="n">x</span><span class="p">),</span><span class="n">I2</span><span class="p">)</span>
      
<span class="k">END PROGRAM </span><span class="n">format_history</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/ecam_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Formatting the HISTORY files of DL_MESO_DPD</a><ul>
<li><a class="reference internal" href="#purpose-of-module">Purpose of Module</a></li>
<li><a class="reference internal" href="#background-information">Background Information</a></li>
<li><a class="reference internal" href="#testing">Testing</a></li>
<li><a class="reference internal" href="#source-code">Source Code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../dipole_dlmeso_dpd/readme.html"
                        title="previous chapter">Analysis of charge dipole moments in DL_MESO_DPD</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../dipole_af_dlmeso_dpd/readme.html"
                        title="next chapter">Autocorrelation functions of charge dipole moments in DL_MESO_DPD</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../../../_sources/Meso-Multi-Scale-Modelling-Modules/modules/DL_MESO_DPD/format_dlmeso_dpd/readme.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../dipole_af_dlmeso_dpd/readme.html" title="Autocorrelation functions of charge dipole moments in DL_MESO_DPD"
             >next</a> |</li>
        <li class="right" >
          <a href="../dipole_dlmeso_dpd/readme.html" title="Analysis of charge dipole moments in DL_MESO_DPD"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">E-CAM Software Library 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Meso- and Multi-scale Modules</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, E-CAM Centre of Excellence.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.
    </div>
  </body>
</html>